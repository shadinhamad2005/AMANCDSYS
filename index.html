<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CD & AMAN Tracker (Multi-Project)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2d3748; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .page { display: none; }
        .page.active { display: block; }
        .action-btn.animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        
        /* Login Screen Styles */
        #login-screen { position: fixed; inset: 0; background: #111827; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #app-container { display: none; height: 100vh; width: 100%; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans antialiased overflow-hidden">

    <div id="login-screen">
        <div class="w-full max-w-md p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white tracking-wider">SYSTEM LOGIN</h1>
                <p class="text-teal-500 text-sm mt-2">CD & Aman Tracker</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-teal-500 outline-none" placeholder="admin@tracker.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-teal-500 outline-none" placeholder="••••••••" required>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit" class="w-full py-3 px-4 bg-teal-600 hover:bg-teal-500 rounded-lg text-white font-bold transition-colors shadow-lg">
                    Access Dashboard
                </button>
            </form>
        </div>
    </div>

    <div id="app-container" class="flex">
        <aside class="w-64 bg-gray-800/30 p-6 border-r border-gray-700/50 flex-shrink-0 flex flex-col">
            <div class="text-center mb-8">
                <h1 class="text-xl font-bold text-white tracking-wider">CD & AMAN</h1>
                <div class="flex items-center justify-center gap-2 mt-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p id="user-display" class="text-xs text-gray-400 truncate max-w-[150px]">User</p>
                </div>
            </div>

            <!-- PROJECT DROPDOWN -->
            <div class="mb-8">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Active Project</label>
                <select id="project-select" class="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-2.5">
                    <option value="Main Project">Main Project</option>
                </select>
            </div>

            <nav id="navigation" class="space-y-4 flex-1">
                <button data-page="Civil Defence" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 bg-teal-600/90 text-white shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                    <span class="flex-1 text-left">Civil Defence</span>
                </button>
                <button data-page="Aman Certificate" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-gray-300 hover:bg-gray-700/50 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><rect width="16" height="20" x="4" y="2" rx="2"></rect><path d="M9 22v-4h6v4"></path><path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path><path d="M12 10h.01"></path><path d="M12 14h.01"></path><path d="M16 10h.01"></path><path d="M16 14h.01"></path><path d="M8 10h.01"></path><path d="M8 14h.01"></path></svg>
                    <span class="flex-1 text-left">Aman Certificate</span>
                </button>
            </nav>
            <button id="logout-btn" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-red-400 hover:bg-red-900/30 rounded-lg transition-colors border border-red-900/30">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>
                Sign Out
            </button>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto h-full">
            
            <!-- Notification Bell and Dropdown -->
            <div class="absolute top-0 right-0 m-6 z-30">
                <div class="relative">
                    <button id="notification-btn" class="p-2 rounded-full text-gray-300 hover:text-white hover:bg-gray-800 transition-colors relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.375 22a2 2 0 1 0 3.25 0"></path></svg>
                        <span id="notification-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
                    </button>
                    <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden max-h-96 overflow-y-auto">
                        <div class="py-1" id="notification-list">
                            <!-- Notifications will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-Civil Defence" class="page active"></div>
            <div id="page-Aman Certificate" class="page"></div>
        </main>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm"></div>

    <script type="module">
        // --------------------------------------------------------------
        // 1. FIREBASE IMPORTS & CONFIGURATION
        // --------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Firebase Realtime Database Configuration (Original content preserved)
        const firebaseConfig = {
          apiKey: "AIzaSyAnsZJnWu5PvC5UDyGL7q2zO9HjePDt5wk",
          authDomain: "amancdsys.firebaseapp.com",
          projectId: "amancdsys",
          storageBucket: "amancdsys.firebasestorage.app",
          messagingSenderId: "335675080686",
          appId: "1:335675080686:web:f38787505d1873c3cf58ff",
          measurementId: "G-F4D55C3MFK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --------------------------------------------------------------
        // 2. AUTHENTICATION LOGIC
        // --------------------------------------------------------------
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');

        // Monitor Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Logged in as:", user.email);
                userDisplay.textContent = user.email;
                loginScreen.style.display = 'none';
                appContainer.style.display = 'flex';
                listenToFirebase();	
            } else {
                console.log("User signed out");
                loginScreen.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

        // Handle Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.classList.add('hidden');

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    loginError.textContent = "Invalid Email or Password.";
                    loginError.classList.remove('hidden');
                });
        });

        // Handle Logout
        logoutBtn.addEventListener('click', () => {
             // Replaced confirm() with an internal message/check for consistency
             showModal("Confirm Sign Out", "<p class='text-gray-300'>Are you sure you want to sign out?</p><div class='flex justify-end gap-4 mt-6'><button id='confirm-logout' class='px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 transition-colors font-semibold'>Sign Out</button><button id='cancel-logout' class='px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold'>Cancel</button></div>", () => {
                document.getElementById('confirm-logout').addEventListener('click', () => {
                    signOut(auth).then(() => {
                        window.location.reload(); 
                    }).catch((error) => {
                        console.error("Error signing out:", error);
                        // Using internal modal instead of alert
                        showModal("Error Signing Out", "<p class='text-red-400'>There was an error signing out. Please try again.</p>");
                    });
                    hideModal();
                });
                document.getElementById('cancel-logout').addEventListener('click', hideModal);
            });
        });


        // --------------------------------------------------------------
        // 3. APP STATE & LOGIC
        // --------------------------------------------------------------
        let cdCerts = [];
        let amanCerts = [];
        let historyData = {};
        let projectsList = new Set(['Main Project']);
        let currentProject = 'Main Project';
        
        let currentPage = 'Civil Defence';
        let currentFilters = {
            'Civil Defence': { validity: 'All', phase: 'All', workflow: 'All', search: '' },
            'Aman Certificate': { validity: 'All', phase: 'All', workflow: 'All', search: '' }
        };

        const CD_WORKFLOW_STEPS = ['Renewal Pending', 'Informed Fire team', 'Awaiting inspection', 'Inspection Date', 'Certificate ready', 'AMC ready'];
        const AMAN_WORKFLOW_STEPS = ['Installation in Progress', 'Pending Renewal', 'Certificate ready'];

        // --------------------------------------------------------------
        // 4. DATABASE FUNCTIONS
        // --------------------------------------------------------------
        
        const saveDataToFirebase = () => {
            if (!auth.currentUser) return; // Don't save if not logged in
            set(ref(db, 'appData'), {
                cdCerts: cdCerts,
                amanCerts: amanCerts,
                historyData: historyData
            }).catch((error) => {
                // Replaced alert
                showModal("Error Saving Data", `<p class='text-red-400'>Error saving to cloud: ${error.message}</p>`);
            });
        };

        const listenToFirebase = () => {
            if (!auth.currentUser) return;
            const dataRef = ref(db, 'appData');
            onValue(dataRef, (snapshot) => {
                const data = snapshot.val();

                if (data) {
                    cdCerts = data.cdCerts || [];
                    amanCerts = data.amanCerts || [];
                    historyData = data.historyData || {};

                    // Update Projects List
                    projectsList = new Set(['Main Project']);
                    [...cdCerts, ...amanCerts].forEach(item => {
                        if(item.project) projectsList.add(item.project);
                    });
                    updateProjectDropdown();
                } else {
                    cdCerts = [];
                    amanCerts = [];
                    historyData = {};
                    updateProjectDropdown();
                }
                render();
                // ADDED: Update notifications after data fetch
                updateNotifications();
            }, (error) => {
                console.error("Error loading data:", error);
                if (error.code === 'PERMISSION_DENIED') {
                    showModal("Access Denied", "<p class='text-red-400'>Access Denied. Please ensure you are logged in correctly.</p>");
                }
            });
        };

        // --------------------------------------------------------------
        // 5. PROJECT LOGIC
        // --------------------------------------------------------------
        const projectSelect = document.getElementById('project-select');

        function updateProjectDropdown() {
            projectSelect.innerHTML = '';
            // Add existing projects
            projectsList.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                if(p === currentProject) option.selected = true;
                projectSelect.appendChild(option);
            });
            // Add Create New Option
            const createOption = document.createElement('option');
            createOption.value = '__CREATE_NEW__';
            createOption.textContent = '+ Create New Project';
            createOption.style.fontWeight = 'bold';
            createOption.style.color = '#2dd4bf'; // Teal
            projectSelect.appendChild(createOption);
        }

        projectSelect.addEventListener('change', (e) => {
            if(e.target.value === '__CREATE_NEW__') {
                const modalContent = `
                    <div class="space-y-4">
                        <label for="newProjectName" class="block text-sm font-medium text-gray-300">Enter the name for the new project (e.g. 'Open Yards Phase 2'):</label>
                        <input type="text" id="newProjectName" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="Project Name" required>
                        <div class="flex justify-end gap-4">
                            <button id="cancel-new-project" class="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold">Cancel</button>
                            <button id="save-new-project" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Create Project</button>
                        </div>
                    </div>`;

                showModal('Create New Project', modalContent, () => {
                    const newNameInput = document.getElementById('newProjectName');
                    newNameInput.focus();

                    document.getElementById('save-new-project').addEventListener('click', () => {
                        const newName = newNameInput.value.trim();
                        if(newName) {
                            projectsList.add(newName);
                            currentProject = newName;
                            updateProjectDropdown();
                            render();
                            hideModal();
                        } else {
                            showModal('Error', "<p class='text-red-400'>Project name cannot be empty.</p>");
                        }
                    });
                    document.getElementById('cancel-new-project').addEventListener('click', () => {
                        projectSelect.value = currentProject; // Revert selection
                        hideModal();
                    });
                });
            } else {
                currentProject = e.target.value;
                render();
            }
        });

        // --------------------------------------------------------------
        // 6. APP LOGIC
        // --------------------------------------------------------------

        const getValidityStatus = (expiryDate) => {
            if (!expiryDate) return { text: 'N/A', color: 'gray' };
            const now = new Date();
            const expiry = new Date(expiryDate);
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(now.getDate() + 30);

            if (expiry < now) return { text: 'Expired', color: 'red' };
            if (expiry <= thirtyDaysFromNow) return { text: 'Near Expiry', color: 'yellow' };
            return { text: 'Valid', color: 'green' };
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date)) return 'Invalid Date';
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        };
        
        const processData = (data) => {
            let valid = 0, nearExpiry = 0, expired = 0;
            data.forEach(item => {
                const status = getValidityStatus(item.expiryDate).text;
                if (status === 'Valid') valid++;
                else if (status === 'Near Expiry') nearExpiry++;
                else if (status === 'Expired') expired++;
            });
            return { valid, nearExpiry, expired };
        };

        // ADDED: Notification Logic
        function generateExpiryNotifications() {
            const notifications = [];
            const now = new Date();
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(now.getDate() + 30);

            // Helper to check for notifications
            const checkCerts = (certs, type) => {
                certs.filter(c => (c.project || 'Main Project') === currentProject).forEach(cert => {
                    if (!cert.expiryDate) return;
                    const expiry = new Date(cert.expiryDate);

                    if (expiry < now) {
                        notifications.push({
                            id: cert.id,
                            type: type,
                            message: `${type === 'Civil Defence' ? 'CD' : 'Aman'} Cert #${cert.propertyNumber} **Expired** on ${formatDate(cert.expiryDate)}!`,
                            urgency: 'red'
                        });
                    } else if (expiry <= thirtyDaysFromNow) {
                        notifications.push({
                            id: cert.id,
                            type: type,
                            message: `${type === 'Civil Defence' ? 'CD' : 'Aman'} Cert #${cert.propertyNumber} **Near Expiry** on ${formatDate(cert.expiryDate)}.`,
                            urgency: 'yellow'
                        });
                    }
                });
            };

            checkCerts(cdCerts, 'Civil Defence');
            checkCerts(amanCerts, 'Aman Certificate');

            return notifications;
        }

        function updateNotifications() {
            const notifications = generateExpiryNotifications();
            const countEl = document.getElementById('notification-count');
            const listEl = document.getElementById('notification-list');
            const bellBtn = document.getElementById('notification-btn');
            
            countEl.textContent = notifications.length;
            if (notifications.length > 0) {
                countEl.classList.remove('hidden');
                bellBtn.classList.add('animate-pulse');
            } else {
                countEl.classList.add('hidden');
                bellBtn.classList.remove('animate-pulse');
            }

            if (notifications.length === 0) {
                listEl.innerHTML = '<p class="p-3 text-center text-gray-400 text-sm">No expiry notifications.</p>';
                return;
            }

            listEl.innerHTML = notifications.map(notif => {
                const colorClass = notif.urgency === 'red' ? 'bg-red-900/40 hover:bg-red-900/60' : 'bg-yellow-900/40 hover:bg-yellow-900/60';
                return `
                    <a href="#" data-id="${notif.id}" data-type="${notif.type}" class="notification-item flex px-4 py-3 border-b border-gray-700 ${colorClass} transition-colors">
                        <div class="flex-shrink-0 pt-1">
                            <span class="w-3 h-3 rounded-full ${notif.urgency === 'red' ? 'bg-red-500' : 'bg-yellow-500'} inline-block"></span>
                        </div>
                        <div class="ml-3 text-sm font-medium text-gray-200">
                            ${notif.message}
                        </div>
                    </a>
                `;
            }).join('');
            
            // Attach click handlers to new list items
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = e.currentTarget.dataset.id;
                    const type = e.currentTarget.dataset.type;
                    handleNotificationClick(id, type);
                });
            });
        }
        
        function handleNotificationClick(id, type) {
            document.getElementById('notification-dropdown').classList.add('hidden');
            currentPage = type; // Switch to the relevant page
            render();
            // Delay opening the modal slightly to ensure the correct page has rendered
            setTimeout(() => {
                handleShowForm(type, id); // Open the edit form
            }, 100);
        }

        function checkAndApplyAutomaticStatusUpdates() {
            let changed = false;
            const today = new Date().setHours(0, 0, 0, 0);

            cdCerts.forEach(cert => {
                // Only check if it belongs to the current project to avoid mass updates on invisible items
                if ((cert.project || 'Main Project') === currentProject && cert.expiryDate) {
                    const expiry = new Date(cert.expiryDate).setHours(0, 0, 0, 0);
                    if (expiry < today) {
                        if (!CD_WORKFLOW_STEPS.includes(cert.workflowStatus) || cert.workflowStatus === 'Certificate ready') {
                            cert.workflowStatus = 'Renewal Pending';
                            changed = true;
                        }
                    }
                }
            });
            
            // Added: Aman Check - Aman only enters 'Pending Renewal' if expired
            amanCerts.forEach(cert => {
                if ((cert.project || 'Main Project') === currentProject && cert.expiryDate) {
                    const expiry = new Date(cert.expiryDate).setHours(0, 0, 0, 0);
                    if (expiry < today) {
                        if (cert.workflowStatus !== 'Pending Renewal' && cert.workflowStatus !== 'Installation in Progress') {
                            cert.workflowStatus = 'Pending Renewal';
                            changed = true;
                        }
                    }
                }
            });

            if (changed) {
                saveDataToFirebase();
            }
        }

        function render() {
            checkAndApplyAutomaticStatusUpdates();
            
            // FILTER DATA BY PROJECT BEFORE RENDERING
            const filteredCdCerts = cdCerts.filter(c => (c.project || 'Main Project') === currentProject);
            const filteredAmanCerts = amanCerts.filter(c => (c.project || 'Main Project') === currentProject);

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const activePage = document.getElementById(`page-${currentPage}`);
            if (activePage) activePage.classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('bg-teal-600/90', 'text-white', 'shadow-lg');
                    link.classList.remove('text-gray-300', 'hover:bg-gray-700/50');
                } else {
                    link.classList.remove('bg-teal-600/90', 'text-white', 'shadow-lg');
                    link.classList.add('text-gray-300', 'hover:bg-gray-700/50');
                }
            });

            switch (currentPage) {
                case 'Civil Defence': renderCertificatePage('Civil Defence', filteredCdCerts); break;
                case 'Aman Certificate': renderCertificatePage('Aman Certificate', filteredAmanCerts); break;
            }
            updateNotifications(); // Re-render notifications whenever main view changes
        }
        
        function generateDetailedDashboard(type, data) {
            const isCivilDefence = type === 'Civil Defence';
            const status = processData(data);
            
            let detailCards = '';

            if(isCivilDefence) {
                const awaitingInspection = data.filter(c => c.workflowStatus === 'Awaiting inspection').length;
                const inspectionDateSet = data.filter(c => c.workflowStatus === 'Inspection Date').length;
                const amcReady = data.filter(c => c.workflowStatus === 'AMC ready').length;
                const renewalPending = data.filter(c => c.workflowStatus === 'Renewal Pending').length;
                  detailCards = `
                    ${generateDetailStatCardHTML(`Total ${currentProject} CD`, data.length)}
                    ${generateDetailStatCardHTML('Valid', status.valid)}
                    ${generateDetailStatCardHTML('Near Expiry', status.nearExpiry)}
                    ${generateDetailStatCardHTML('Expired', status.expired)}
                    ${generateDetailStatCardHTML('Renewal Pending', renewalPending)}
                    ${generateDetailStatCardHTML('Awaiting Inspection', awaitingInspection)}
                    ${generateDetailStatCardHTML('Inspection Set', inspectionDateSet)}
                    ${generateDetailStatCardHTML('AMC Ready', amcReady)}
                `;
            } else { // Aman
                const installing = data.filter(c => c.workflowStatus === 'Installation in Progress').length;
                const renewalPending = data.filter(c => c.workflowStatus === 'Pending Renewal').length;
                const ready = data.filter(c => c.workflowStatus === 'Certificate ready').length;
                  detailCards = `
                    ${generateDetailStatCardHTML(`Total ${currentProject} Aman`, data.length)}
                    ${generateDetailStatCardHTML('Valid', status.valid)}
                    ${generateDetailStatCardHTML('Near Expiry', status.nearExpiry)}
                    ${generateDetailStatCardHTML('Expired', status.expired)}
                    ${generateDetailStatCardHTML('Installation in Progress', installing)}
                    ${generateDetailStatCardHTML('Pending Renewal', renewalPending)}
                    ${generateDetailStatCardHTML('Certificate Ready', ready)}
                `;
            }
            
            return `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">${detailCards}</div>`;
        }

        function generateDetailStatCardHTML(title, value) {
            return `
            <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50 text-center">
                <p class="text-2xl font-bold text-white">${value}</p>
                <p class="text-sm text-gray-400">${title}</p>
            </div>
            `;
        }
        
        function renderCertificatePage(type, data) {
            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';
            const typeId = type.replace(/\s+/g, '-');
            const PROPERTY_SECTIONS = {'Warehouse': 'warehouse', 'OPY': 'openyard', 'Admin': 'admin building', 'Others': 'others'};
            const pageEl = document.getElementById(`page-${type}`);

            const sectionsHTML = Object.keys(PROPERTY_SECTIONS).map(sectionTitle => {
                return `
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-teal-400 mb-4">${sectionTitle}</h2>
                    <div class="bg-gray-800/50 border border-gray-700/50 rounded-2xl overflow-hidden shadow-lg backdrop-blur-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-800">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Property Number</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Phase</th>
                                        ${isCivilDefence ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Issue Date</th>' : ''}
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Expiry Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Validity Status</th>
                                        ${isAman ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Device ID</th>' : ''}
                                        ${isAman ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Serial No.</th>' : ''}
                                        ${isCivilDefence || isAman ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Workflow Status</th>' : ''}
                                        ${!isCivilDefence && !isAman ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Notes</th>' : ''}
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body-${sectionTitle.replace(/\s+/g, '-')}-${typeId}" class="bg-gray-900/50 divide-y divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                `
            }).join('');
            
            const detailDashboardHTML = generateDetailedDashboard(type, data);

            const searchPlaceholder = isCivilDefence ? "Search by Property No..." : "Search by Property, Account, Record, Device, or Serial No...";

            pageEl.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <h1 class="text-4xl font-bold text-white">${type} Certificates</h1>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button id="import-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" x2="12" y1="3" y2="15"></line></svg>Import Data
                        </button>
                        <button id="export-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>Export Data
                        </button>
                        <button id="download-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>Download Report
                        </button>
                        <button id="add-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-teal-600 hover:bg-teal-500 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>Add New
                        </button>
                    </div>
                </div>
                ${detailDashboardHTML}
                <div class="mb-6">
                    <div class="filter-controls flex space-x-1 bg-gray-800 p-1 rounded-lg" data-type="${typeId}">
                        ${["All", "Valid", "Near Expiry", "Expired"].map(f => `<button data-filter-type="validity" data-filter-value="${f}" class="filter-btn w-full py-2.5 text-sm font-medium leading-5 rounded-lg transition-colors ${currentFilters[type].validity === f ? 'bg-teal-600 text-white shadow' : 'text-gray-300 hover:bg-gray-700'}">${f}</button>`).join('')}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="relative md:col-span-1">
                        <input type="search" id="search-input-${typeId}" placeholder="${searchPlaceholder}" value="${currentFilters[type].search}" class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div>
                        <select id="phase-filter-${typeId}" data-filter-type="phase" class="filter-select w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-teal-500">
                            <option value="All">All Phases</option>
                            <option value="Phase 1">Phase 1</option>
                            <option value="Phase 2">Phase 2</option>
                            <option value="OPY">OPY</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    ${isCivilDefence || isAman ? `
                    <div>
                        <select id="workflow-filter-${typeId}" data-filter-type="workflow" class="filter-select w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-teal-500">
                            <option value="All">All Workflow</option>
                            ${ (isCivilDefence ? CD_WORKFLOW_STEPS : AMAN_WORKFLOW_STEPS).map(step => `<option value="${step}">${step}</option>`).join('')}
                        </select>
                    </div>
                    ` : '<div></div>'}
                </div>

                ${sectionsHTML}
                `;

            renderAllTables(type, data);
            
            const phaseFilter = pageEl.querySelector(`#phase-filter-${typeId}`);
            if (phaseFilter) phaseFilter.value = currentFilters[type].phase;
            
            if(isCivilDefence || isAman) {
                const workflowFilter = pageEl.querySelector(`#workflow-filter-${typeId}`);
                if (workflowFilter) workflowFilter.value = currentFilters[type].workflow;
            }

            // --- Event Listeners for this page ---
            pageEl.querySelector(`#add-btn-${typeId}`).addEventListener('click', () => handleShowForm(type));
            pageEl.querySelector(`#import-btn-${typeId}`).addEventListener('click', () => handleShowImportModal(type));
            pageEl.querySelector(`#export-btn-${typeId}`).addEventListener('click', () => handleExportData(type, data));
            pageEl.querySelector(`#download-btn-${typeId}`).addEventListener('click', () => handleDownloadReport(type));

            pageEl.querySelector(`#search-input-${typeId}`).addEventListener('input', (e) => {
                currentFilters[type].search = e.target.value;
                renderAllTables(type, data);
            });

            pageEl.querySelectorAll(`.filter-select`).forEach(select => {
                select.addEventListener('change', (e) => {
                    const filterType = e.target.dataset.filterType;
                    currentFilters[type][filterType] = e.target.value;
                    renderAllTables(type, data);
                });
            });

            const filterControls = pageEl.querySelector(`.filter-controls[data-type="${typeId}"]`);
            if(filterControls) {
                filterControls.addEventListener('click', (e) => {
                    if(e.target.matches('.filter-btn')) {
                        const filterType = e.target.dataset.filterType;
                        const filterValue = e.target.dataset.filterValue;
                        currentFilters[type][filterType] = filterValue;
                        
                        filterControls.querySelectorAll(`.filter-btn`).forEach(btn => {
                            btn.classList.toggle('bg-teal-600', btn.dataset.filterValue === filterValue);
                            btn.classList.toggle('text-white', btn.dataset.filterValue === filterValue);
                            btn.classList.toggle('shadow', btn.dataset.filterValue === filterValue);
                            btn.classList.toggle('text-gray-300', btn.dataset.filterValue !== filterValue);
                            btn.classList.toggle('hover:bg-gray-700', btn.dataset.filterValue !== filterValue);
                        });
                        renderAllTables(type, data);
                    }
                });
            }
        }
        
        function renderAllTables(type, data) {
            const filters = currentFilters[type];
            const typeId = type.replace(/\s+/g, '-');
            const PROPERTY_SECTIONS = {'Warehouse': 'warehouse', 'OPY': 'openyard', 'Admin': 'admin building', 'Others': 'others'};
            
            // Helper function to safely get lowercase value of a field, defaulting to empty string if the property is null/undefined
            const getLower = (item, field) => String(item[field] || '').toLowerCase();

            let filteredData = data.filter(item => {
                const validityMatch = filters.validity === 'All' || getValidityStatus(item.expiryDate).text === filters.validity;
                
                let searchMatch = !filters.search;
                if(filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    
                    if (type === 'Aman Certificate') {
                        searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm)) ||
                                        (getLower(item, 'accountId').includes(searchTerm)) ||
                                        (getLower(item, 'recordId').includes(searchTerm)) ||
                                        (getLower(item, 'deviceId').includes(searchTerm)) || 
                                        (getLower(item, 'serialNumber').includes(searchTerm)); 
                    } else { // Civil Defence
                        searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm));
                    }
                }

                const phaseMatch = filters.phase === 'All' || item.phase === filters.phase;
                const workflowMatch = filters.workflow === 'All' || item.workflowStatus === filters.workflow;
                return validityMatch && searchMatch && phaseMatch && workflowMatch;
            });

            filteredData.sort((a, b) => {
                return String(a.propertyNumber).localeCompare(String(b.propertyNumber), undefined, { numeric: true, sensitivity: 'base' });
            });


            const groupedData = filteredData.reduce((acc, item) => {
                const itemType = item.propertyType ? item.propertyType.toLowerCase() : 'others';
                let section = 'Others'; // Default
                for(const key in PROPERTY_SECTIONS){
                    if(PROPERTY_SECTIONS[key] === itemType){
                        section = key;
                        break;
                    }
                }

                if (!acc[section]) {
                    acc[section] = [];
                }
                acc[section].push(item);
                return acc;
            }, { 'Warehouse': [], 'OPY': [], 'Admin': [], 'Others': [] });

            Object.keys(PROPERTY_SECTIONS).forEach(sectionTitle => {
                const sectionData = groupedData[sectionTitle] || [];
                renderTableSection(type, sectionTitle, sectionData);
            });
        }
        
        function renderTableSection(type, sectionTitle, data) {
            const typeId = type.replace(/\s+/g, '-');
            const tableBody = document.getElementById(`table-body-${sectionTitle.replace(/\s+/g, '-')}-${typeId}`);
            if(!tableBody) return;
            
            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';
            const today = new Date().setHours(0,0,0,0);
            
            // Calculate colspan dynamically
            let totalColumns = 6; // Property No, Phase, Expiry, Validity, Workflow/Notes, Actions
            if (isCivilDefence) totalColumns += 1; // + Issue Date
            if (isAman) totalColumns += 2; // + Device ID, Serial No.

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${totalColumns}" class="text-center py-10 text-gray-400">No certificates in this section.</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(item => {
                let updateStatusButton = '';
                if (isCivilDefence && item.workflowStatus === 'Inspection Date' && item.inspectionDate && new Date(item.inspectionDate).setHours(0,0,0,0) <= today) {
                    updateStatusButton = `<button class="action-btn text-yellow-400 hover:text-yellow-300 animate-pulse" data-action="update-inspection" data-id="${item.id}" title="Update Inspection Status"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg></button>`;
                }
                
                let workflowCell = '<td class="px-6 py-4"></td>';
                   if (isCivilDefence || isAman) {
                    const steps = isCivilDefence ? CD_WORKFLOW_STEPS : AMAN_WORKFLOW_STEPS;
                    const typeData = isCivilDefence ? 'Civil Defence' : 'Aman Certificate';
                    workflowCell = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                            <div class="relative inline-block text-left">
                                <div>
                                    <button type="button" class="workflow-status-btn inline-flex justify-center w-full" data-id="${item.id}" aria-expanded="true" aria-haspopup="true">
                                        ${generateWorkflowBadge(item.workflowStatus, item.inspectionDate, typeData)}
                                    </button>
                                </div>
                                <div id="workflow-dropdown-${item.id}" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20" role="menu" aria-orientation="vertical" tabindex="-1">
                                    <div class="py-1" role="none">
                                        ${steps.map(step => `<a href="#" class="workflow-option text-gray-200 block px-4 py-2 text-sm hover:bg-gray-600" role="menuitem" tabindex="-1" data-id="${item.id}" data-type="${typeData}" data-new-status="${step}">${step}</a>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </td>`;
                }
                
                // NEW: View Details icon
                const viewDetailsIcon = `<button class="action-btn text-blue-400 hover:text-blue-300" data-action="view-details" data-id="${item.id}" data-type="${type}" title="View Details"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>`;


                return `
                <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${item.propertyNumber || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.phase || ''}</td>
                    ${isCivilDefence ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatDate(item.issueDate)}</td>` : ''}
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatDate(item.expiryDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${generateStatusBadge(getValidityStatus(item.expiryDate))}</td>
                    ${isAman ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.deviceId || ''}</td>` : ''}
                    ${isAman ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.serialNumber || ''}</td>` : ''}
                    ${workflowCell}
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center justify-end space-x-2">
                        ${updateStatusButton}
                        ${viewDetailsIcon} <!-- NEW VIEW DETAILS BUTTON -->
                        <button class="action-btn text-purple-400 hover:text-purple-300" data-action="history" data-id="${item.id}" title="View History"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
                        <button class="action-btn text-teal-400 hover:text-teal-300" data-action="edit" data-id="${item.id}" data-type="${type}" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg></button>
                        <button class="action-btn text-red-500 hover:text-red-400" data-action="delete" data-id="${item.id}" data-type="${type}" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg></button>
                    </td>
                </tr>
            `}).join('');
        }
        
        function generateStatusBadge(status) {
            const colors = { green: "bg-green-500/20 text-green-400 border border-green-500/30", yellow: "bg-yellow-500/20 text-yellow-400 border border-yellow-500/30", red: "bg-red-500/20 text-red-400 border border-red-500/30", gray: "bg-gray-500/20 text-gray-400 border border-gray-500/30" };
            return `<span class="px-3 py-1 text-xs font-semibold rounded-full ${colors[status.color]}">${status.text}</span>`;
        }
        
        function generateWorkflowBadge(status, inspectionDate, type) {
            const cdColors = {	
                'Renewal Pending': "bg-red-500/20 text-red-400 border-red-500/30",
                'Informed Fire team': "bg-orange-500/20 text-orange-400 border-orange-500/30",
                'Awaiting inspection': "bg-yellow-500/20 text-yellow-400 border-yellow-500/30",
                'Inspection Date': "bg-blue-500/20 text-blue-400 border-blue-500/30",
                'Certificate ready': "bg-cyan-500/20 text-cyan-400 border-cyan-500/30",
                'AMC ready': "bg-purple-500/20 text-purple-400 border-purple-500/30",
            };

            const amanColors = {
                'Installation in Progress': "bg-yellow-500/20 text-yellow-400 border-yellow-500/30",
                'Pending Renewal': "bg-red-500/20 text-red-400 border-red-500/30",
                'Certificate ready': "bg-cyan-500/20 text-cyan-400 border-cyan-500/30",
            };

            const colors = type === 'Civil Defence' ? cdColors : amanColors;

            let text = status || 'N/A';
            if (status === 'Inspection Date' && inspectionDate) {
                text = `Inspection: ${formatDate(inspectionDate)}`;
            }

            return `<span class="px-3 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${colors[status] || 'bg-gray-500/20 text-gray-400 border-gray-500/30'}">${text}</span>`;
        }

        // --- Modals and Forms ---
        function showModal(title, content, onOpen = null) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-lg m-4 max-h-[90vh] flex flex-col">
                    <div class="flex items-center justify-between p-5 border-b border-gray-700 flex-shrink-0">
                        <h3 class="text-xl font-bold text-white">${title}</h3>
                        <button id="modal-close-btn" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto">${content}</div>
                </div>`;
            modalContainer.classList.remove('hidden');
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);
            if(onOpen) onOpen();
        }

        function hideModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            modalContainer.classList.add('hidden');
        }
        
        // Handle Show Details Modal
        function handleShowDetailsModal(id, type) {
            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            const cert = dataArray.find(c => c.id === id);
            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';
            
            if (!cert) return showModal("Error", "<p class='text-red-400'>Certificate not found.</p>");

            const detailsMap = [
                { label: 'Property Number', value: cert.propertyNumber },
                { label: 'Project', value: cert.project || 'Main Project' },
                { label: 'Phase', value: cert.phase || 'N/A' },
                { label: 'Type', value: cert.propertyType ? cert.propertyType.toUpperCase() : 'N/A' },
                { label: 'Validity Status', value: generateStatusBadge(getValidityStatus(cert.expiryDate)), html: true },
                { label: 'Expiry Date', value: formatDate(cert.expiryDate) },
                { label: 'Workflow Status', value: generateWorkflowBadge(cert.workflowStatus, cert.inspectionDate, type), html: true },
            ];

            if (isCivilDefence) {
                detailsMap.splice(5, 0, { label: 'Issue Date', value: formatDate(cert.issueDate) });
                detailsMap.push({ label: 'AMC Only', value: cert.amcOnly === 'on' || cert.amcOnly === true ? 'Yes' : 'No' });
            }
            if (isAman) {
                detailsMap.push({ label: 'Account ID', value: cert.accountId || 'N/A' });
                detailsMap.push({ label: 'Record ID', value: cert.recordId || 'N/A' });
                detailsMap.push({ label: 'Device ID', value: cert.deviceId || 'N/A' });
                detailsMap.push({ label: 'Serial Number', value: cert.serialNumber || 'N/A' });
            }
            detailsMap.push({ label: 'Notes', value: cert.notes || 'N/A', fullWidth: true });

            const detailsHtml = detailsMap.map(detail => `
                <div class="${detail.fullWidth ? 'md:col-span-2' : 'col-span-1'} p-3 bg-gray-700/50 rounded-lg">
                    <p class="text-xs font-semibold text-gray-400">${detail.label}</p>
                    <p class="text-sm font-medium text-white mt-1">
                        ${detail.html ? detail.value : (detail.value || 'N/A')}
                    </p>
                </div>
            `).join('');

            const certificateButton = cert.certificateLink ? `
                <div class="md:col-span-2 mt-6">
                    <h4 class="text-lg font-bold text-teal-400 mb-3">Linked Document</h4>
                    <a href="${cert.certificateLink}" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-3 px-6 py-3 rounded-lg bg-teal-600 hover:bg-teal-500 transition-colors text-white font-bold shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="10" y1="13" x2="14" y2="13"></line><line x1="10" y1="17" x2="14" y2="17"></line><line x1="10" y1="9" x2="10" y2="9"></line></svg>
                        View Certificate PDF
                    </a>
                    <p class="text-xs text-gray-400 mt-2 text-center">Clicking the button opens the PDF link you provided in a new tab.</p>
                </div>
            ` : `<p class="md:col-span-2 mt-4 text-center text-yellow-400">No certificate PDF link provided for this entry.</p>`;

            const modalContent = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${detailsHtml}
                    ${certificateButton}
                </div>
            `;
            
            showModal(`${type} Details: ${cert.propertyNumber}`, modalContent);
        }

        function handleShowForm(type, id = null, isRenewal = false) {
            const data = type === 'Civil Defence' ? cdCerts : amanCerts;
            const cert = id ? data.find(c => c.id === id) : null;
            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';


            let title = id ? `Edit ${type} Certificate` : `Add New ${type} Certificate`;
            if (isRenewal) title = `Renew Certificate for ${cert?.propertyNumber || 'N/A'}`;
            
            const formContent = `
                <form id="cert-form" class="space-y-6">
                    <input type="hidden" name="isRenewal" value="${isRenewal}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="propertyNumber" class="block text-sm font-medium text-gray-300 mb-2">Property Number</label>
                            <input type="text" id="propertyNumber" name="propertyNumber" value="${cert?.propertyNumber || ''}" required class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" placeholder="e.g., 243" ${isRenewal ? 'readonly' : ''}>
                        </div>
                        <div>
                            <label for="phase" class="block text-sm font-medium text-gray-300 mb-2">Phase</label>
                            <select id="phase" name="phase" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" ${isRenewal ? 'disabled' : ''}>
                                <option value="Phase 1" ${cert?.phase === 'Phase 1' ? 'selected' : ''}>Phase 1</option>
                                <option value="Phase 2" ${cert?.phase === 'Phase 2' ? 'selected' : ''}>Phase 2</option>
                                <option value="OPY" ${cert?.phase === 'OPY' ? 'selected' : ''}>OPY</option>
                                <option value="Other" ${cert?.phase === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="propertyType" class="block text-sm font-medium text-gray-300 mb-2">Property Type</label>
                            <select id="propertyType" name="propertyType" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" ${isRenewal ? 'disabled' : ''}>
                                <option value="warehouse" ${cert?.propertyType === 'warehouse' ? 'selected' : ''}>Warehouse</option>
                                <option value="openyard" ${cert?.propertyType === 'openyard' ? 'selected' : ''}>OPY</option>
                                <option value="admin building" ${cert?.propertyType === 'admin building' ? 'selected' : ''}>Admin Building</option>
                                <option value="others" ${cert?.propertyType === 'others' ? 'selected' : ''}>Others</option>
                            </select>
                        </div>
                        ${isAman ? `
                        <div>
                            <label for="accountId" class="block text-sm font-medium text-gray-300 mb-2">Account ID</label>
                            <input type="text" id="accountId" name="accountId" value="${cert?.accountId || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" placeholder="e.g., ACC123">
                        </div>
                        <div>
                            <label for="recordId" class="block text-sm font-medium text-gray-300 mb-2">Record ID</label>
                            <input type="text" id="recordId" name="recordId" value="${cert?.recordId || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" placeholder="e.g., REC123">
                        </div>
                        <!-- ADDED FIELDS -->
                        <div>
                            <label for="deviceId" class="block text-sm font-medium text-gray-300 mb-2">Device ID</label>
                            <input type="text" id="deviceId" name="deviceId" value="${cert?.deviceId || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" placeholder="e.g., DVC456">
                        </div>
                        <div>
                            <label for="serialNumber" class="block text-sm font-medium text-gray-300 mb-2">Serial Number</label>
                            <input type="text" id="serialNumber" name="serialNumber" value="${cert?.serialNumber || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" placeholder="e.g., SN789">
                        </div>
                        ` : ''}
                    </div>
                    
                    <div id="date-fields-wrapper">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            ${isCivilDefence ? `
                            <div>
                                <label for="issueDate" class="block text-sm font-medium text-gray-300 mb-2">Issue Date</label>
                                <input type="date" id="issueDate" name="issueDate" value="${isRenewal ? '' : (cert?.issueDate || '')}" required class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            </div>
                            ` : ''}
                            <div>
                                <label for="expiryDate" class="block text-sm font-medium text-gray-300 mb-2">Expiry Date</label>
                                <input type="date" id="expiryDate" name="expiryDate" value="${isRenewal ? '' : (cert?.expiryDate || '')}" required class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            </div>
                        </div>
                    </div>

                    ${isCivilDefence ? `
                    <div class="col-span-2 flex items-center pt-4">
                        <input type="checkbox" id="amcOnly" name="amcOnly" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" ${cert?.amcOnly ? 'checked' : ''}>
                        <label for="amcOnly" class="ml-2 block text-sm text-gray-300">AMC only</label>
                    </div>
                    ` : ''}
                    
                    <div id="notes-wrapper">
                        <label for="notes" class="block text-sm font-medium text-gray-300 mb-2">Notes</label>
                        <textarea id="notes" name="notes" rows="3" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" placeholder="Add any relevant notes...">${cert?.notes || ''}</textarea>
                    </div>
                    <div id="file-wrapper">
                        <label for="certificateLink" class="block text-sm font-medium text-gray-300 mb-2">Certificate PDF Link (URL)</label>
                        <p class="text-xs text-gray-500 mb-2">Link to a publicly hosted PDF document (e.g., Google Drive, Sharepoint, Firebase Storage).</p>
                        <input type="url" id="certificateLink" name="certificateLink" value="${cert?.certificateLink || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" placeholder="https://link.to/your/certificate.pdf">
                        ${cert?.certificateLink ? `<p class="text-xs text-gray-400 mt-2">Currently linked: <a href="${cert.certificateLink}" target="_blank" rel="noopener noreferrer" class="font-semibold text-teal-400 hover:text-teal-300">View Link</a></p>` : ''}
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="form-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold">Cancel</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Save Certificate</button>
                    </div>
                </form>`;

            showModal(title, formContent, () => {
                 if (isCivilDefence) {
                    const amcOnlyCheckbox = document.getElementById('amcOnly');
                    const dateFieldsWrapper = document.getElementById('date-fields-wrapper');
                    const issueDateInput = document.getElementById('issueDate');
                    const expiryDateInput = document.getElementById('expiryDate');

                    const toggleDateFields = () => {
                        if (amcOnlyCheckbox.checked) {
                            dateFieldsWrapper.classList.add('hidden');
                            issueDateInput.required = false;
                            expiryDateInput.required = false;
                        } else {
                            dateFieldsWrapper.classList.remove('hidden');
                            issueDateInput.required = true;
                            expiryDateInput.required = true;
                        }
                    };
                    
                    amcOnlyCheckbox.addEventListener('change', toggleDateFields);
                    toggleDateFields(); // Initial check
                }
            });
            document.getElementById('cert-form').addEventListener('submit', (e) => handleSave(e, type, id));
            document.getElementById('form-cancel-btn').addEventListener('click', hideModal);
        }


        function handleShowImportModal(type) {
            const modalContent = `
                <div class="space-y-4">
                    <p class="text-gray-300 text-sm">Paste your JSON array of certificates below. Each object in the array should match the certificate structure.</p>
                    <textarea id="json-import-area" class="w-full h-48 bg-gray-900 border border-gray-600 rounded-lg p-3 text-white font-mono text-sm" placeholder='[{"propertyNumber": "P1", "certificateLink": "https://...", ...}]'></textarea>
                    <div class="flex justify-end">
                        <button id="import-json-btn" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Import Data</button>
                    </div>
                </div>`;
            showModal(`Import ${type} Data via JSON`, modalContent);
            document.getElementById('import-json-btn').addEventListener('click', () => {
                const jsonText = document.getElementById('json-import-area').value;
                try {
                    const data = JSON.parse(jsonText);
                    if (Array.isArray(data)) {
                        let skippedCount = 0;
                        const dataToImport = data.filter(cert => {
                            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
                            const isDuplicate = dataArray.some(existingCert => existingCert.propertyNumber.trim().toLowerCase() === cert.propertyNumber.trim().toLowerCase() && (existingCert.project || 'Main Project') === currentProject);
                            if (isDuplicate) {
                                skippedCount++;
                                return false;
                            }
                            return true;
                        });

                        dataToImport.forEach(cert => {
                            // PRESERVE WORKFLOW STATUS IF IT EXISTS
                            if(!cert.project) cert.project = currentProject; // Assign current project to imported data
                            handleOperation(type, 'add', null, cert)
                        });
                        
                        if (skippedCount > 0) {
                            showModal("Import Notice", `<p class='text-yellow-400'>${skippedCount} duplicate certificate(s) were skipped during import.</p>`);
                        }
                        hideModal();
                    } else {
                        showModal("Import Error", "<p class='text-red-400'>Pasted text is not a valid JSON array.</p>");
                    }
                } catch(e) {
                    showModal("Import Error", `<p class='text-red-400'>Error parsing JSON: ${e.message}</p>`);
                }
            });
        }
        
        function handleShowHistoryModal(id) {
            const history = historyData[id] || [];
            if (history.length === 0) {
                showModal('Certificate History', '<p>No history found for this certificate.</p>');
                return;
            }
            const historyList = history.sort((a,b) => new Date(b.archivedAt) - new Date(a.archivedAt)).map(entry => `
                <div class="p-4 bg-gray-700/50 rounded-lg mb-3">
                    <p class="text-sm text-gray-400">Archived on: ${formatDate(entry.archivedAt)}</p>
                    <p><strong>Expiry Date:</strong> ${formatDate(entry.expiryDate)}</p>
                    ${entry.certificateLink ? `<p class="text-sm"><strong>Linked PDF:</strong> <a href="${entry.certificateLink}" target="_blank" rel="noopener noreferrer" class="text-teal-400 hover:text-teal-300">View Link</a></p>` : ''}
                </div>
            `).join('');
            
            showModal('Certificate History', `<div class="max-h-80 overflow-y-auto">${historyList}</div>`);
        }

        function handleUpdateInspectionStatus(id) {
            const modalContent = `
                <p class="text-gray-300 mb-6">What was the result of the inspection?</p>
                <div class="flex justify-end gap-4">
                     <button id="inspection-fail-btn" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 transition-colors font-semibold">Fail</button>
                     <button id="inspection-pass-btn" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-500 transition-colors font-semibold">Pass</button>
                </div>`;

            showModal('Update Inspection Status', modalContent, () => {
                document.getElementById('inspection-pass-btn').addEventListener('click', () => {
                    hideModal();
                    handleShowForm('Civil Defence', id, true); // Open edit form with a flag for renewal
                });

                document.getElementById('inspection-fail-btn').addEventListener('click', () => {
                     const certIndex = cdCerts.findIndex(c => c.id === id);
                     if (certIndex !== -1) {
                         cdCerts[certIndex].workflowStatus = 'Awaiting inspection';
                         cdCerts[certIndex].inspectionDate = ''; // Clear the date
                         saveDataToFirebase(); // Cloud Save
                         hideModal();
                         render();
                     }
                });
            });
        }

        // --- Data Operations ---
        function handleSave(e, type, id) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            let data = Object.fromEntries(formData.entries());
            // No file handling needed anymore, using certificateLink URL instead
            
            handleOperation(type, id ? 'update' : 'add', id, data);
        }

        function handleOperation(type, operation, id, data) {
            if (operation === 'delete') {
                 // Replaced confirm() with modal
                showModal("Confirm Deletion", "<p class='text-gray-300'>Are you sure you want to permanently delete this certificate record?</p><div class='flex justify-end gap-4 mt-6'><button id='confirm-delete' class='px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 transition-colors font-semibold'>Delete</button><button id='cancel-delete' class='px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold'>Cancel</button></div>", () => {
                    document.getElementById('confirm-delete').addEventListener('click', () => {
                         if(type === 'Civil Defence') {
                            cdCerts = cdCerts.filter(c => c.id !== id);
                        } else {
                            amanCerts = amanCerts.filter(c => c.id !== id);
                        }
                        saveDataToFirebase(); // Cloud Save
                        render();
                        hideModal();
                    });
                    document.getElementById('cancel-delete').addEventListener('click', hideModal);
                });
                return;	
            }

            let dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            
            // Determine Project
            const entryProject = (data && data.project) ? data.project : currentProject;
            
            const propertyNumber = data.propertyNumber.trim();

            if (!propertyNumber) {
                showModal("Validation Error", "<p class='text-red-400'>Property Number cannot be empty.</p>");
                return;
            }

            if (operation === 'add') {
                // Check duplicate WITHIN current project - THIS IS THE CASE-INSENSITIVE VALIDATION
                const isDuplicate = dataArray.some(cert => cert.propertyNumber.trim().toLowerCase() === propertyNumber.toLowerCase() && (cert.project || 'Main Project') === entryProject);
                if (isDuplicate) {
                    showModal("Validation Error", `<p class='text-red-400'>Error: A certificate for Property Number "${propertyNumber}" already exists in this project. (It may be stored with different capitalization, please search for it to find it.)</p>`);
                    return;
                }

                // Conditionally build Aman-specific data object
                const amanFields = type === 'Aman Certificate' ? {
                    deviceId: data.deviceId || '',
                    serialNumber: data.serialNumber || ''
                } : {};

                let newCert = {	
                    ...data,	
                    propertyNumber,	
                    id: String(Date.now()),	
                    createdAt: new Date().toISOString(),
                    project: entryProject,
                    // Spread Aman fields only if type is Aman
                    ...amanFields,
                    // Link Field
                    certificateLink: data.certificateLink || ''
                };

                // BUG FIX: Check if workflowStatus was passed (from import), otherwise use default logic
                if(type === 'Civil Defence'){
                    if (data.workflowStatus) {
                        newCert.workflowStatus = data.workflowStatus;
                    } else {
                        newCert.workflowStatus = data.amcOnly === 'on' ? 'AMC ready' : 'Renewal Pending';
                    }
                    
                    if(data.amcOnly === 'on'){
                        newCert.issueDate = '';
                        newCert.expiryDate = '';
                    }
                } else if (type === 'Aman Certificate') {
                    if (data.workflowStatus) {
                        newCert.workflowStatus = data.workflowStatus;
                    } else {
                        newCert.workflowStatus = 'Installation in Progress';
                    }
                }
                dataArray.push(newCert);
            } else if (operation === 'update') {
                const isDuplicate = dataArray.some(cert => cert.propertyNumber.trim().toLowerCase() === propertyNumber.toLowerCase() && cert.id !== id && (cert.project || 'Main Project') === entryProject);
                 if (isDuplicate) {
                    showModal("Validation Error", `<p class='text-red-400'>Error: Another certificate with Property Number "${propertyNumber}" already exists in this project.</p>`);
                    return;	
                }
                const certIndex = dataArray.findIndex(c => c.id === id);
                if (certIndex !== -1) {
                    const originalCert = { ...dataArray[certIndex] };
                    
                    // HISTORY LOGIC ADDED HERE
                      if (!historyData[id]) {
                        historyData[id] = [];
                    }
                    // Only push old version if expiry or link changed
                    if (originalCert.expiryDate !== data.expiryDate || originalCert.certificateLink !== data.certificateLink) {
                       historyData[id].push({ ...originalCert, archivedAt: new Date().toISOString() });
                    }
                    
                    let updatedCert = { ...originalCert, ...data, propertyNumber, lastUpdated: new Date().toISOString() };
                    
                    if (data.isRenewal === 'true') {
                        updatedCert.workflowStatus = 'Certificate ready';	
                        updatedCert.inspectionDate = '';	
                        updatedCert.amcOnly = false; // A renewal implies it's not AMC only
                    }
                    
                    if(type === 'Civil Defence' && data.amcOnly === 'on'){
                        updatedCert.workflowStatus = 'AMC ready';
                        updatedCert.issueDate = '';
                        updatedCert.expiryDate = '';
                    }

                    // Aman Fields handling on update (only update if present in form data)
                    if (type === 'Aman Certificate') {
                        updatedCert.deviceId = data.deviceId || '';
                        updatedCert.serialNumber = data.serialNumber || '';
                    } else {
                        // Ensure CD certs DO NOT have these properties when saving to Firebase
                        delete updatedCert.deviceId;
                        delete updatedCert.serialNumber;
                    }
                    
                    // Update certificate link
                    updatedCert.certificateLink = data.certificateLink || '';
                    
                    dataArray[certIndex] = updatedCert;
                }
            }
            
            saveDataToFirebase(); // Cloud Save
            hideModal();
            render();
            updateNotifications(); // Update notifications after saving data
        }
        
        function handleDownloadReport(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape'); // Changed to landscape for wider Aman table
            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            const filters = currentFilters[type];
            
            // Helper function to safely get lowercase value of a field, defaulting to empty string if the property is null/undefined
            const getLower = (item, field) => String(item[field] || '').toLowerCase();

            // Filter for REPORT (Apply Project Filter)
            const projectData = dataArray.filter(c => (c.project || 'Main Project') === currentProject);

            const reportData = projectData.filter(item => {
                const validityMatch = filters.validity === 'All' || getValidityStatus(item.expiryDate).text === filters.validity;
                
                let searchMatch = !filters.search;
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    if (type === 'Aman Certificate') {
                        searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm)) ||
                                        (getLower(item, 'accountId').includes(searchTerm)) ||
                                        (getLower(item, 'recordId').includes(searchTerm)) ||
                                        (getLower(item, 'deviceId').includes(searchTerm)) || 
                                        (getLower(item, 'serialNumber').includes(searchTerm)); 
                    } else { // Civil Defence
                        searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm));
                    }
                }
                const phaseMatch = filters.phase === 'All' || item.phase === filters.phase;
                const workflowMatch = filters.workflow === 'All' || item.workflowStatus === filters.workflow;
                return validityMatch && searchMatch && phaseMatch && workflowMatch;
            });

            if (reportData.length === 0) {
                showModal("Report Generation Failed", "<p class='text-yellow-400'>No data to report based on the current filters.</p>");
                return;
            }
            
            reportData.sort((a, b) => String(a.propertyNumber).localeCompare(String(b.propertyNumber), undefined, { numeric: true, sensitivity: 'base' }));

            const title = `${type} Certificate Report - ${currentProject}`;
            const date = new Date().toLocaleDateString('en-GB');
            
            doc.setFontSize(18);
            doc.text(title, 14, 22);
            doc.setFontSize(11);
            doc.text(`Report generated on: ${date}`, 14, 30);

            const isCivilDefence = type === 'Civil Defence';
            
            const head = isCivilDefence	
                ? [['Property No.', 'Phase', 'Issue Date', 'Expiry Date', 'Validity', 'Workflow']]
                : [['Property No.', 'Phase', 'Expiry Date', 'Validity', 'Account ID', 'Record ID', 'Device ID', 'Serial No.']]; 

            const body = reportData.map(item => {
                if (isCivilDefence) {
                    let workflowText = item.workflowStatus || 'N/A';
                    if(item.workflowStatus === 'Inspection Date' && item.inspectionDate) {
                        workflowText = `Inspection: ${formatDate(item.inspectionDate)}`;
                    }
                    return [
                        item.propertyNumber || '',
                        item.phase || '',
                        formatDate(item.issueDate),
                        formatDate(item.expiryDate),
                        getValidityStatus(item.expiryDate).text,
                        workflowText
                    ];
                } else {
                    return [
                        item.propertyNumber || '',
                        item.phase || '',
                        formatDate(item.expiryDate),
                        getValidityStatus(item.expiryDate).text,
                        item.accountId || '',
                        item.recordId || '',
                        item.deviceId || '', 
                        item.serialNumber || '' 
                    ];
                }
            });

            doc.autoTable({
                startY: 35,
                head: head,
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [22, 160, 133] }, // Teal color
            });

            doc.save(`${type.replace(/\s/g, '_')}_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function handleExportData(type, data) {
            // Filter Export Data by Current Project
            const projectData = data.filter(c => (c.project || 'Main Project') === currentProject);
            
            if (projectData.length === 0) {
                showModal("Export Failed", `<p class='text-yellow-400'>No data to export for ${type} in ${currentProject}.</p>`);
                return;
            }

            const jsonContent = JSON.stringify(projectData, null, 2);	
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${type.replace(/\s/g, '_')}_${currentProject.replace(/\s/g, '_')}_Export.json`;
            link.click();
            URL.revokeObjectURL(link.href);
        }
        
        function handleSetInspectionDate(id) {
            const modalContent = `
                <div class="space-y-4">
                    <label for="modalInspectionDate" class="block text-sm font-medium text-gray-300">Please select the inspection date:</label>
                    <input type="date" id="modalInspectionDate" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    <div class="flex justify-end mt-4">
                        <button id="save-inspection-date-btn" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Set Date</button>
                    </div>
                </div>`;

            showModal('Set Inspection Date', modalContent, () => {
                document.getElementById('save-inspection-date-btn').addEventListener('click', () => {
                    const newDate = document.getElementById('modalInspectionDate').value;
                    if (!newDate) {
                        showModal("Validation Error", "<p class='text-red-400'>Please select a date.</p>");
                        return;
                    }
                    const certIndex = cdCerts.findIndex(c => c.id === id);
                    if (certIndex !== -1) {
                        cdCerts[certIndex].workflowStatus = 'Inspection Date';
                        cdCerts[certIndex].inspectionDate = newDate;
                        saveDataToFirebase(); // Cloud Save
                        hideModal();
                        render();
                    }
                });
            });
        }


        // --- Event Listeners ---
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.workflow-status-btn') && !e.target.closest('#notification-btn')) {
                // Close workflow dropdowns
                document.querySelectorAll('[id^="workflow-dropdown-"]').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                });
                // Close notification dropdown
                if (!e.target.closest('#notification-dropdown')) {
                    document.getElementById('notification-dropdown').classList.add('hidden');
                }
            }
        });

        document.getElementById('navigation').addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                currentPage = navLink.dataset.page;
                render();
            }
        });

        // ADDED: Notification button toggle
        document.getElementById('notification-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
        });
        
        document.querySelector('main').addEventListener('click', (e) => {
            const actionBtn = e.target.closest('.action-btn');
            const workflowBtn = e.target.closest('.workflow-status-btn');
            const workflowOption = e.target.closest('.workflow-option');

            if (workflowBtn) {
                e.preventDefault();
                e.stopPropagation();	
                const id = workflowBtn.dataset.id;
                const dropdown = document.getElementById(`workflow-dropdown-${id}`);
                
                document.querySelectorAll('[id^="workflow-dropdown-"]').forEach(d => {
                    if (d.id !== dropdown.id) {
                        d.classList.add('hidden');
                    }
                });

                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            } else if (workflowOption) {
                e.preventDefault();
                const id = workflowOption.dataset.id;
                const newStatus = workflowOption.dataset.newStatus;
                const type = workflowOption.dataset.type;
                
                const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
                const certIndex = dataArray.findIndex(c => c.id === id);
                if (certIndex === -1) return;

                if (newStatus === 'Inspection Date') { // This is CD specific
                    handleSetInspectionDate(id);
                } else {
                    dataArray[certIndex].workflowStatus = newStatus;
                    if (newStatus !== 'Inspection Date') {
                        dataArray[certIndex].inspectionDate = '';
                    }
                    saveDataToFirebase(); // Cloud Save
                    render();
                }
                
                workflowOption.closest('[id^="workflow-dropdown-"]').classList.add('hidden');
            } else if (actionBtn) {
                const { action, id, type } = actionBtn.dataset;
                if (action === 'edit') {
                    handleShowForm(type, id);
                } else if (action === 'delete') {
                    handleOperation(type, 'delete', id, null);	
                } else if (action === 'history') {
                    handleShowHistoryModal(id);
                } else if (action === 'view-details') { // NEW ACTION HANDLER
                    handleShowDetailsModal(id, type);
                } else if (action === 'update-inspection') {
                    handleUpdateInspectionStatus(id);
                }
            }
        });

        // --- Initialization ---
        function initialize() {
            // We wait for auth to complete to load data from Firebase
        }

        initialize();
    </script>
</body>
</html>
