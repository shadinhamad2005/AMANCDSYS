<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CD & AMAN Tracker (Multi-Project)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2d3748; }
        /* Adjusted color filter for calendar picker in dark mode for better visibility */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        .page { display: none; }
        .page.active { display: block; }
        .action-btn.animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        
        /* Login Screen Styles */
        #login-screen { position: fixed; inset: 0; background: #111827; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #app-container { display: none; height: 100vh; width: 100%; }
        /* Style for date inputs to keep calendar picker visible */
        input[type="date"] { color-scheme: dark; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans antialiased overflow-hidden">

    <div id="login-screen">
        <div class="w-full max-w-md p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white tracking-wider">SYSTEM LOGIN</h1>
                <p class="text-teal-500 text-sm mt-2">CD & Aman Tracker</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-teal-500 outline-none" placeholder="admin@tracker.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-teal-500 outline-none" placeholder="••••••••" required>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit" class="w-full py-3 px-4 bg-teal-600 hover:bg-teal-500 rounded-lg text-white font-bold transition-colors shadow-lg">
                    Access Dashboard
                </button>
            </form>
        </div>
    </div>

    <div id="app-container" class="flex">
        <aside class="w-64 bg-gray-800/30 p-6 border-r border-gray-700/50 flex-shrink-0 flex flex-col">
            <div class="text-center mb-8">
                <h1 class="text-xl font-bold text-white tracking-wider">CD & AMAN</h1>
                <div class="flex items-center justify-center gap-2 mt-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p id="user-display" class="text-xs text-gray-400 truncate max-w-[150px]">User</p>
                </div>
            </div>

            <!-- PROJECT DROPDOWN -->
            <div class="mb-8">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Active Project</label>
                <select id="project-select" class="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-2.5">
                    <option value="Main Project">Main Project</option>
                </select>
            </div>

            <nav id="navigation" class="space-y-4 flex-1">
                <button data-page="Civil Defence" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 bg-teal-600/90 text-white shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                    <span class="flex-1 text-left">Civil Defence</span>
                </button>
                <button data-page="Aman Certificate" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-gray-300 hover:bg-gray-700/50 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><rect width="16" height="20" x="4" y="2" rx="2"></rect><path d="M9 22v-4h6v4"></path><path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path><path d="M12 10h.01"></path><path d="M12 14h.01"></path><path d="M16 10h.01"></path><path d="M16 14h.01"></path><path d="M8 10h.01"></path><path d="M8 14h.01"></path></svg>
                    <span class="flex-1 text-left">Aman Certificate</span>
                </button>
            </nav>
            <button id="logout-btn" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-red-400 hover:bg-red-900/30 rounded-lg transition-colors border border-red-900/30">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>
                Sign Out
            </button>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto h-full">
            
            <!-- Notification Bell and Dropdown -->
            <div class="absolute top-0 right-0 m-6 z-30">
                <div class="relative">
                    <button id="notification-btn" class="p-2 rounded-full text-gray-300 hover:text-white hover:bg-gray-800 transition-colors relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.375 22a2 2 0 1 0 3.25 0"></path></svg>
                        <span id="notification-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
                    </button>
                    <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden max-h-96 overflow-y-auto">
                        <div class="py-1" id="notification-list">
                            <!-- Notifications will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-Civil Defence" class="page active"></div>
            <div id="page-Aman Certificate" class="page"></div>
        </main>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm"></div>

    <script type="module">
        // --------------------------------------------------------------
        // 1. FIREBASE IMPORTS & CONFIGURATION
        // --------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Firebase Realtime Database Configuration (Original content preserved)
        // NOTE: This uses Firebase Realtime Database and not Firestore as per the original code.
        const firebaseConfig = {
          apiKey: "AIzaSyAnsZJnWu5PvC5UDyGL7q2zO9HjePDt5wk",
          authDomain: "amancdsys.firebaseapp.com",
          projectId: "amancdsys",
          storageBucket: "amancdsys.firebasestorage.app",
          messagingSenderId: "335675080686",
          appId: "1:335675080686:web:f38787505d1873c3cf58ff",
          measurementId: "G-F4D55C3MFK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --------------------------------------------------------------
        // 2. AUTHENTICATION LOGIC
        // --------------------------------------------------------------
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');

        // Monitor Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Logged in as:", user.email);
                userDisplay.textContent = user.email;
                loginScreen.style.display = 'none';
                appContainer.style.display = 'flex';
                listenToFirebase();	
            } else {
                console.log("User signed out");
                loginScreen.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

        // Handle Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.classList.add('hidden');

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    loginError.textContent = "Invalid Email or Password.";
                    loginError.classList.remove('hidden');
                });
        });

        // Handle Logout
        logoutBtn.addEventListener('click', () => {
             // Replaced confirm() with an internal message/check for consistency
             showModal("Confirm Sign Out", "<p class='text-gray-300'>Are you sure you want to sign out?</p><div class='flex justify-end gap-4 mt-6'><button id='confirm-logout' class='px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 transition-colors font-semibold'>Sign Out</button><button id='cancel-logout' class='px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold'>Cancel</button></div>", () => {
                document.getElementById('confirm-logout').addEventListener('click', () => {
                    signOut(auth).then(() => {
                        window.location.reload();	
                    }).catch((error) => {
                        console.error("Error signing out:", error);
                        // Using internal modal instead of alert
                        showModal("Error Signing Out", "<p class='text-red-400'>There was an error signing out. Please try again.</p>");
                    });
                    hideModal();
                });
                document.getElementById('cancel-logout').addEventListener('click', hideModal);
            });
        });


        // --------------------------------------------------------------
        // 3. APP STATE & LOGIC
        // --------------------------------------------------------------
        let cdCerts = [];
        let amanCerts = [];
        let historyData = {}; // For CD/Aman certificate old expiry/link history
        let projectsList = new Set(['Main Project']);
        let currentProject = 'Main Project';
        
        // ** STEP 1: DEFINE THE AUTHORIZED ADMIN UID **
        // NOTE: Replace 'YOUR_ADMIN_FIREBASE_UID_HERE' with the actual UID of the user who should have edit access.
        // If left as a placeholder, no one will have edit access.
        const ADMIN_UID = '2xs0IlmRDDYwbekOuXsv2ThWBCl2'; 

        // Helper function to check if the current user is authorized
        const isAuthorizedEditor = () => {
            return auth.currentUser && auth.currentUser.uid === ADMIN_UID;
        };
        
        let currentPage = 'Civil Defence';
        let currentFilters = {
            'Civil Defence': { validity: 'All', phase: 'All', workflow: 'All', search: '' },
            'Aman Certificate': { validity: 'All', phase: 'All', workflow: 'All', search: '' }
        };

        const CD_WORKFLOW_STEPS = ['Renewal Pending', 'Informed Fire team', 'Awaiting inspection', 'Inspection Date', 'Certificate ready', 'AMC ready'];
        const AMAN_WORKFLOW_STEPS = ['Installation in Progress', 'Pending Renewal', 'Certificate ready'];

        // --------------------------------------------------------------
        // 4. DATABASE FUNCTIONS
        // --------------------------------------------------------------
        
        const saveDataToFirebase = () => {
            if (!auth.currentUser) return; // Don't save if not logged in
            set(ref(db, 'appData'), {
                cdCerts: cdCerts,
                amanCerts: amanCerts,
                historyData: historyData
            }).catch((error) => {
                // Replaced alert
                showModal("Error Saving Data", `<p class='text-red-400'>Error saving to cloud: ${error.message}</p>`);
            });
        };

        const listenToFirebase = () => {
            if (!auth.currentUser) return;
            const dataRef = ref(db, 'appData');
            onValue(dataRef, (snapshot) => {
                const data = snapshot.val();

                if (data) {
                    cdCerts = data.cdCerts || [];
                    // Ensure renewalHistory is initialized for Aman Cets
                    amanCerts = (data.amanCerts || []).map(c => ({
                        ...c,
                        renewalHistory: c.renewalHistory || [] // Initialize or keep array
                    }));
                    historyData = data.historyData || {};

                    // Update Projects List
                    projectsList = new Set(['Main Project']);
                    [...cdCerts, ...amanCerts].forEach(item => {
                        if(item.project) projectsList.add(item.project);
                    });
                    updateProjectDropdown();
                } else {
                    cdCerts = [];
                    amanCerts = [];
                    historyData = {};
                    updateProjectDropdown();
                }
                render();
                // ADDED: Update notifications after data fetch
                updateNotifications();
            }, (error) => {
                console.error("Error loading data:", error);
                if (error.code === 'PERMISSION_DENIED') {
                    showModal("Access Denied", "<p class='text-red-400'>Access Denied. Please ensure you are logged in correctly.</p>");
                }
            });
        };

        // --------------------------------------------------------------
        // 5. PROJECT LOGIC
        // --------------------------------------------------------------
        const projectSelect = document.getElementById('project-select');

        function updateProjectDropdown() {
            projectSelect.innerHTML = '';
            // Add existing projects
            projectsList.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                if(p === currentProject) option.selected = true;
                projectSelect.appendChild(option);
            });
            // Add Create New Option
            const createOption = document.createElement('option');
            createOption.value = '__CREATE_NEW__';
            createOption.textContent = '+ Create New Project';
            createOption.style.fontWeight = 'bold';
            createOption.style.color = '#2dd4bf'; // Teal
            projectSelect.appendChild(createOption);
        }

        projectSelect.addEventListener('change', (e) => {
            if(e.target.value === '__CREATE_NEW__') {
                const modalContent = `
                    <div class="space-y-4">
                        <label for="newProjectName" class="block text-sm font-medium text-gray-300">Enter the name for the new project (e.g. 'Open Yards Phase 2'):</label>
                        <input type="text" id="newProjectName" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="Project Name" required>
                        <div class="flex justify-end gap-4">
                            <button id="cancel-new-project" class="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold">Cancel</button>
                            <button id="save-new-project" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Create Project</button>
                        </div>
                    </div>`;

                showModal('Create New Project', modalContent, () => {
                    const newNameInput = document.getElementById('newProjectName');
                    newNameInput.focus();

                    document.getElementById('save-new-project').addEventListener('click', () => {
                        const newName = newNameInput.value.trim();
                        if(newName) {
                            projectsList.add(newName);
                            currentProject = newName;
                            updateProjectDropdown();
                            render();
                            hideModal();
                        } else {
                            showModal('Error', "<p class='text-red-400'>Project name cannot be empty.</p>");
                        }
                    });
                    document.getElementById('cancel-new-project').addEventListener('click', hideModal);
                });
            } else {
                currentProject = e.target.value;
                render();
            }
        });

        // --------------------------------------------------------------
        // 6. APP STATE & LOGIC
        // --------------------------------------------------------------

        const getValidityStatus = (expiryDate) => {
            if (!expiryDate) return { text: 'N/A', color: 'gray' };
            const now = new Date();
            const expiry = new Date(expiryDate);
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(now.getDate() + 30);

            if (expiry < now) return { text: 'Expired', color: 'red' };
            if (expiry <= thirtyDaysFromNow) return { text: 'Near Expiry', color: 'yellow' };
            return { text: 'Valid', color: 'green' };
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date)) return 'Invalid Date';
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        };
        
        const processData = (data) => {
            let valid = 0, nearExpiry = 0, expired = 0;
            data.forEach(item => {
                const status = getValidityStatus(item.expiryDate).text;
                if (status === 'Valid') valid++;
                else if (status === 'Near Expiry') nearExpiry++;
                else if (status === 'Expired') expired++;
            });
            return { valid, nearExpiry, expired };
        };

        // ADDED: Notification Logic
        function generateExpiryNotifications() {
            const notifications = [];
            const now = new Date();
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(now.getDate() + 30);

            // Helper to check for notifications
            const checkCerts = (certs, type) => {
                certs.filter(c => (c.project || 'Main Project') === currentProject).forEach(cert => {
                    if (!cert.expiryDate) return;
                    const expiry = new Date(cert.expiryDate);

                    if (expiry < now) {
                        notifications.push({
                            id: cert.id,
                            type: type,
                            message: `${type === 'Civil Defence' ? 'CD' : 'Aman'} Cert #${cert.propertyNumber} **Expired** on ${formatDate(cert.expiryDate)}!`,
                            urgency: 'red'
                        });
                    } else if (expiry <= thirtyDaysFromNow) {
                        notifications.push({
                            id: cert.id,
                            type: type,
                            message: `${type === 'Civil Defence' ? 'CD' : 'Aman'} Cert #${cert.propertyNumber} **Near Expiry** on ${formatDate(cert.expiryDate)}.`,
                            urgency: 'yellow'
                        });
                    }
                });
            };

            checkCerts(cdCerts, 'Civil Defence');
            checkCerts(amanCerts, 'Aman Certificate');

            return notifications;
        }

        function updateNotifications() {
            const notifications = generateExpiryNotifications();
            const countEl = document.getElementById('notification-count');
            const listEl = document.getElementById('notification-list');
            const bellBtn = document.getElementById('notification-btn');
            
            countEl.textContent = notifications.length;
            if (notifications.length > 0) {
                countEl.classList.remove('hidden');
                bellBtn.classList.add('animate-pulse');
            } else {
                countEl.classList.add('hidden');
                bellBtn.classList.remove('animate-pulse');
            }

            if (notifications.length === 0) {
                listEl.innerHTML = '<p class="p-3 text-center text-gray-400 text-sm">No expiry notifications.</p>';
                return;
            }

            listEl.innerHTML = notifications.map(notif => {
                const colorClass = notif.urgency === 'red' ? 'bg-red-900/40 hover:bg-red-900/60' : 'bg-yellow-900/40 hover:bg-yellow-900/60';
                return `
                    <a href="#" data-id="${notif.id}" data-type="${notif.type}" class="notification-item flex px-4 py-3 border-b border-gray-700 ${colorClass} transition-colors">
                        <div class="flex-shrink-0 pt-1">
                            <span class="w-3 h-3 rounded-full ${notif.urgency === 'red' ? 'bg-red-500' : 'bg-yellow-500'} inline-block"></span>
                        </div>
                        <div class="ml-3 text-sm font-medium text-gray-200">
                            ${notif.message.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>')}
                        </div>
                    </a>
                `;
            }).join('');
            
            // Attach click handlers to new list items
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = e.currentTarget.dataset.id;
                    const type = e.currentTarget.dataset.type;
                    handleNotificationClick(id, type);
                });
            });
        }
        
        function handleNotificationClick(id, type) {
            document.getElementById('notification-dropdown').classList.add('hidden');
            currentPage = type; // Switch to the relevant page
            render();
            // Delay opening the modal slightly to ensure the correct page has rendered
            setTimeout(() => {
                handleShowForm(type, id); // Open the edit form
            }, 100);
        }

        function checkAndApplyAutomaticStatusUpdates() {
            let changed = false;
            const today = new Date().setHours(0, 0, 0, 0);

            cdCerts.forEach(cert => {
                // Only check if it belongs to the current project to avoid mass updates on invisible items
                if ((cert.project || 'Main Project') === currentProject && cert.expiryDate) {
                    const expiry = new Date(cert.expiryDate).setHours(0, 0, 0, 0);
                    if (expiry < today) {
                        if (!CD_WORKFLOW_STEPS.includes(cert.workflowStatus) || cert.workflowStatus === 'Certificate ready') {
                            cert.workflowStatus = 'Renewal Pending';
                            changed = true;
                        }
                    }
                }
            });
            
            // Added: Aman Check - Aman only enters 'Pending Renewal' if expired
            amanCerts.forEach(cert => {
                if ((cert.project || 'Main Project') === currentProject && cert.expiryDate) {
                    const expiry = new Date(cert.expiryDate).setHours(0, 0, 0, 0);
                    if (expiry < today) {
                        if (cert.workflowStatus !== 'Pending Renewal' && cert.workflowStatus !== 'Installation in Progress') {
                            cert.workflowStatus = 'Pending Renewal';
                            changed = true;
                        }
                    }
                }
            });

            if (changed) {
                saveDataToFirebase();
            }
        }

        function render() {
            checkAndApplyAutomaticStatusUpdates();
            
            // FILTER DATA BY PROJECT BEFORE RENDERING
            const filteredCdCerts = cdCerts.filter(c => (c.project || 'Main Project') === currentProject);
            const filteredAmanCerts = amanCerts.filter(c => (c.project || 'Main Project') === currentProject);

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const activePage = document.getElementById(`page-${currentPage}`);
            if (activePage) activePage.classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('bg-teal-600/90', 'text-white', 'shadow-lg');
                    link.classList.remove('text-gray-300', 'hover:bg-gray-700/50');
                } else {
                    link.classList.remove('bg-teal-600/90', 'text-white', 'shadow-lg');
                    link.classList.add('text-gray-300', 'hover:bg-gray-700/50');
                }
            });

            switch (currentPage) {
                case 'Civil Defence': renderCertificatePage('Civil Defence', filteredCdCerts); break;
                case 'Aman Certificate': renderCertificatePage('Aman Certificate', filteredAmanCerts); break;
            }
            updateNotifications(); // Re-render notifications whenever main view changes
        }
        
        function generateDetailedDashboard(type, data) {
            const isCivilDefence = type === 'Civil Defence';
            const status = processData(data);
            
            let detailCards = '';

            if(isCivilDefence) {
                const awaitingInspection = data.filter(c => c.workflowStatus === 'Awaiting inspection').length;
                const inspectionDateSet = data.filter(c => c.workflowStatus === 'Inspection Date').length;
                const amcReady = data.filter(c => c.workflowStatus === 'AMC ready').length;
                const renewalPending = data.filter(c => c.workflowStatus === 'Renewal Pending').length;
                 detailCards = `
                    ${generateDetailStatCardHTML(`Total ${currentProject} CD`, data.length)}
                    ${generateDetailStatCardHTML('Valid', status.valid)}
                    ${generateDetailStatCardHTML('Near Expiry', status.nearExpiry)}
                    ${generateDetailStatCardHTML('Expired', status.expired)}
                    ${generateDetailStatCardHTML('Renewal Pending', renewalPending)}
                    ${generateDetailStatCardHTML('Awaiting Inspection', awaitingInspection)}
                    ${generateDetailStatCardHTML('Inspection Set', inspectionDateSet)}
                    ${generateDetailStatCardHTML('AMC Ready', amcReady)}
                `;
            } else { // Aman
                const installing = data.filter(c => c.workflowStatus === 'Installation in Progress').length;
                const renewalPending = data.filter(c => c.workflowStatus === 'Pending Renewal').length;
                const ready = data.filter(c => c.workflowStatus === 'Certificate ready').length;
                 detailCards = `
                    ${generateDetailStatCardHTML(`Total ${currentProject} Aman`, data.length)}
                    ${generateDetailStatCardHTML('Valid', status.valid)}
                    ${generateDetailStatCardHTML('Near Expiry', status.nearExpiry)}
                    ${generateDetailStatCardHTML('Expired', status.expired)}
                    ${generateDetailStatCardHTML('Installation in Progress', installing)}
                    ${generateDetailStatCardHTML('Pending Renewal', renewalPending)}
                    ${generateDetailStatCardHTML('Certificate Ready', ready)}
                `;
            }
            
            return `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">${detailCards}</div>`;
        }

        function generateDetailStatCardHTML(title, value) {
            return `
            <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50 text-center">
                <p class="text-2xl font-bold text-white">${value}</p>
                <p class="text-sm text-gray-400">${title}</p>
            </div>
            `;
        }
        
        function renderCertificatePage(type, data) {
            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';
            const typeId = type.replace(/\s+/g, '-');
            // Consistent map used for routing and rendering sections
            const PROPERTY_SECTIONS = {'Warehouse': 'warehouse', 'OPY': 'opy', 'Admin': 'admin', 'Others': 'others'};
            const pageEl = document.getElementById(`page-${type}`);
            
            // Check authorization once
            const isEditor = isAuthorizedEditor();

            const sectionsHTML = Object.keys(PROPERTY_SECTIONS).map(sectionTitle => {
                // Determine if Phase column should be shown (only for Warehouse)
                const isWarehouse = sectionTitle === 'Warehouse';
                return `
                <div class="mb-8">
                    <!-- Section Title -->
                    <h2 class="text-2xl font-bold text-teal-400 mb-4">${sectionTitle}</h2>
                    <div class="bg-gray-800/50 border border-gray-700/50 rounded-2xl overflow-hidden shadow-lg backdrop-blur-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-800">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Property Number</th>
                                        ${isWarehouse ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Phase</th>' : ''}
                                        ${isCivilDefence ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Issue Date</th>' : ''}
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Expiry Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Validity Status</th>
                                        ${isAman ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Device ID</th>' : ''}
                                        ${isAman ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Serial No.</th>' : ''}
                                        ${isCivilDefence || isAman ? '<th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider">Workflow Status</th>' : ''}
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <!-- Updated table body to dark mode theme -->
                                <tbody id="table-body-${sectionTitle.replace(/\s+/g, '-')}-${typeId}" class="divide-y divide-gray-700 text-white">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                `
            }).join('');
            
            const detailDashboardHTML = generateDetailedDashboard(type, data);

            const searchPlaceholder = isCivilDefence ? "Search by Property No..." : "Search by Property, Account, Record, Device, or Serial No...";

            pageEl.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <h1 class="text-4xl font-bold text-white">${type} Certificates</h1>
                    <div class="flex items-center gap-2 flex-wrap">
                        ${isEditor ? `
                        <button id="import-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" x2="12" y1="3" y2="15"></line></svg>Import Data
                        </button>
                        <button id="export-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>Export Data
                        </button>
                        ` : ''}
                        <button id="download-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>Download Report
                        </button>
                        ${isAman ? `
                        <button id="financial-report-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-yellow-600 hover:bg-yellow-500 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            Financial Report
                        </button>` : ''}
                        ${isEditor ? `
                        <button id="add-btn-${typeId}" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-teal-600 hover:bg-teal-500 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>Add New
                        </button>
                        ` : ''}
                    </div>
                </div>
                ${detailDashboardHTML}
                <div class="mb-6">
                    <div class="filter-controls flex space-x-1 bg-gray-800 p-1 rounded-lg" data-type="${typeId}">
                        ${["All", "Valid", "Near Expiry", "Expired"].map(f => `<button data-filter-type="validity" data-filter-value="${f}" class="filter-btn w-full py-2.5 text-sm font-medium leading-5 rounded-lg transition-colors ${currentFilters[type].validity === f ? 'bg-teal-600 text-white shadow' : 'text-gray-300 hover:bg-gray-700'}">${f}</button>`).join('')}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="relative md:col-span-1">
                        <input type="search" id="search-input-${typeId}" placeholder="${searchPlaceholder}" value="${currentFilters[type].search}" class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div>
                        <select id="phase-filter-${typeId}" data-filter-type="phase" class="filter-select w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-teal-500">
                            <option value="All">All Phases</option>
                            <option value="Phase 1">Phase 1</option>
                            <option value="Phase 2">Phase 2</option>
                            <option value="OPY">OPY</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    ${isCivilDefence || isAman ? `
                    <div>
                        <select id="workflow-filter-${typeId}" data-filter-type="workflow" class="filter-select w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-teal-500">
                            <option value="All">All Workflow</option>
                            ${ (isCivilDefence ? CD_WORKFLOW_STEPS : AMAN_WORKFLOW_STEPS).map(step => `<option value="${step}">${step}</option>`).join('')}
                        </select>
                    </div>
                    ` : '<div></div>'}
                </div>

                ${sectionsHTML}
                `;

            renderAllTables(type, data);
            
            const phaseFilter = pageEl.querySelector(`#phase-filter-${typeId}`);
            if (phaseFilter) phaseFilter.value = currentFilters[type].phase;
            
            if(isCivilDefence || isAman) {
                const workflowFilter = pageEl.querySelector(`#workflow-filter-${typeId}`);
                if (workflowFilter) workflowFilter.value = currentFilters[type].workflow;
            }

            // --- Event Listeners for this page ---
            if (isEditor) {
                pageEl.querySelector(`#add-btn-${typeId}`).addEventListener('click', () => handleShowForm(type));
                pageEl.querySelector(`#import-btn-${typeId}`).addEventListener('click', () => handleShowImportModal(type));
                pageEl.querySelector(`#export-btn-${typeId}`).addEventListener('click', () => handleExportData(type, data));
            }
            pageEl.querySelector(`#download-btn-${typeId}`).addEventListener('click', () => handleDownloadReport(type));
            
            if (isAman) {
                // Show modal with PDF/CSV options
                pageEl.querySelector(`#financial-report-btn-${typeId}`).addEventListener('click', handleShowFinancialReportOptions);
            }


            pageEl.querySelector(`#search-input-${typeId}`).addEventListener('input', (e) => {
                currentFilters[type].search = e.target.value;
                renderAllTables(type, data);
            });

            pageEl.querySelectorAll(`.filter-select`).forEach(select => {
                select.addEventListener('change', (e) => {
                    const filterType = e.target.dataset.filterType;
                    currentFilters[type][filterType] = e.target.value;
                    renderAllTables(type, data);
                });
            });

            const filterControls = pageEl.querySelector(`.filter-controls[data-type="${typeId}"]`);
            if(filterControls) {
                filterControls.addEventListener('click', (e) => {
                    if(e.target.matches('.filter-btn')) {
                        const filterType = e.target.dataset.filterType;
                        const filterValue = e.target.dataset.filterValue;
                        currentFilters[type][filterType] = filterValue;
                        
                        filterControls.querySelectorAll(`.filter-btn`).forEach(btn => {
                            btn.classList.toggle('bg-teal-600', btn.dataset.filterValue === filterValue);
                            btn.classList.toggle('text-white', btn.dataset.filterValue === filterValue);
                            btn.classList.toggle('shadow', btn.dataset.filterValue === filterValue);
                            btn.classList.toggle('text-gray-300', btn.dataset.filterValue !== filterValue);
                            btn.classList.toggle('hover:bg-gray-700', btn.dataset.filterValue !== filterValue);
                        });
                        renderAllTables(type, data);
                    }
                });
            }
        }
        
        function renderAllTables(type, data) {
            const filters = currentFilters[type];
            const typeId = type.replace(/\s+/g, '-');
            // Consistent map used for routing and rendering sections
            const PROPERTY_SECTIONS = {'Warehouse': 'warehouse', 'OPY': 'opy', 'Admin': 'admin', 'Others': 'others'};

            // Helper function to safely get lowercase value of a field, defaulting to empty string if the property is null/undefined
            const getLower = (item, field) => String(item[field] || '').toLowerCase();

            let filteredData = data.filter(item => {
                const validityMatch = filters.validity === 'All' || getValidityStatus(item.expiryDate).text === filters.validity;
                
                let searchMatch = !filters.search;
                if(filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    
                    if (type === 'Aman Certificate') {
                        searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm)) ||
                                                (getLower(item, 'accountId').includes(searchTerm)) ||
                                                (getLower(item, 'recordId').includes(searchTerm)) ||
                                                (getLower(item, 'deviceId').includes(searchTerm)) || 
                                                (getLower(item, 'serialNumber').includes(searchTerm)); 
                    } else { // Civil Defence
                        searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm));
                    }
                }

                const phaseMatch = filters.phase === 'All' || item.phase === filters.phase;
                const workflowMatch = filters.workflow === 'All' || item.workflowStatus === filters.workflow;
                return validityMatch && searchMatch && phaseMatch && workflowMatch;
            });

            filteredData.sort((a, b) => {
                return String(a.propertyNumber).localeCompare(String(b.propertyNumber), undefined, { numeric: true, sensitivity: 'base' });
            });


            const groupedData = filteredData.reduce((acc, item) => {
                // Robust Routing Logic
                let itemType = item.propertyType ? item.propertyType.toLowerCase().replace(/\s/g, '') : 'others';
                
                // Handle various forms of old property names to map to standardized keys
                if (itemType.includes('openyard')) itemType = 'opy';
                if (itemType.includes('adminbuilding')) itemType = 'admin';
                if (itemType === 'warehouse' || itemType === 'warehouses') itemType = 'warehouse';
                if (itemType === 'admin') itemType = 'admin';
                if (itemType === 'opy') itemType = 'opy';


                let section = 'Others'; // Default
                for(const key in PROPERTY_SECTIONS){
                    if(PROPERTY_SECTIONS[key] === itemType){
                        section = key;
                        break;
                    }
                }

                if (!acc[section]) {
                    acc[section] = [];
                }
                acc[section].push(item);
                return acc;
            }, { 'Warehouse': [], 'OPY': [], 'Admin': [], 'Others': [] });

            Object.keys(PROPERTY_SECTIONS).forEach(sectionTitle => {
                const sectionData = groupedData[sectionTitle] || [];
                renderTableSection(type, sectionTitle, sectionData);
            });
        }
        
        function renderTableSection(type, sectionTitle, data) {
            const typeId = type.replace(/\s+/g, '-');
            const tableBody = document.getElementById(`table-body-${sectionTitle.replace(/\s+/g, '-')}-${typeId}`);
            if(!tableBody) return;
            
            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';
            const today = new Date().setHours(0,0,0,0);
            
            // Authorization Check
            const isEditor = isAuthorizedEditor();

            // Phase column is ONLY rendered for Warehouse
            const renderPhaseColumn = sectionTitle === 'Warehouse';
            
            // Calculate colspan dynamically
            let totalColumns = 5; // Property No, Expiry, Validity, Workflow/Notes, Actions
            if (renderPhaseColumn) totalColumns += 1; // + Phase Column
            if (isCivilDefence) totalColumns += 1; // + Issue Date
            if (isAman) totalColumns += 2; // + Device ID, Serial No.

            if (data.length === 0) {
                // Changed table text color to reflect dark theme
                tableBody.innerHTML = `<tr><td colspan="${totalColumns}" class="text-center py-10 text-gray-400 bg-gray-800/50">No certificates in this section matching criteria.</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(item => {
                const validityStatus = getValidityStatus(item.expiryDate);
                const isRenewable = validityStatus.text === 'Expired' || validityStatus.text === 'Near Expiry';

                let updateStatusButton = '';
                if (isCivilDefence && item.workflowStatus === 'Inspection Date' && item.inspectionDate && new Date(item.inspectionDate).setHours(0,0,0,0) <= today) {
                    updateStatusButton = `<button class="action-btn text-yellow-500 hover:text-yellow-700 animate-pulse" data-action="update-inspection" data-id="${item.id}" title="Update Inspection Status"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg></button>`;
                }
                
                // UPDATED RENEWAL ICON
                const renewalButton = isRenewable ? `
                    <button class="action-btn text-green-500 hover:text-green-700" data-action="renew" data-id="${item.id}" data-type="${type}" title="Renew Certificate">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7L21 16"/></svg>
                    </button>
                ` : '';

                let workflowCell = `<td class="px-6 py-4 bg-gray-800/50"></td>`;
                    if (isCivilDefence || isAman) {
                    const steps = isCivilDefence ? CD_WORKFLOW_STEPS : AMAN_WORKFLOW_STEPS;
                    const typeData = isCivilDefence ? 'Civil Defence' : 'Aman Certificate';
                    workflowCell = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm bg-gray-800/50">
                            <div class="relative inline-block text-left">
                                <div>
                                    <button type="button" class="workflow-status-btn inline-flex justify-center w-full" data-id="${item.id}" aria-expanded="true" aria-haspopup="true" ${!isEditor ? 'disabled' : ''}>
                                        ${generateWorkflowBadge(item.workflowStatus, item.inspectionDate, typeData)}
                                    </button>
                                </div>
                                <div id="workflow-dropdown-${item.id}" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20" role="menu" aria-orientation="vertical" tabindex="-1">
                                    ${isEditor ? `
                                    <div class="py-1" role="none">
                                        ${steps.map(step => `<a href="#" class="workflow-option text-gray-200 block px-4 py-2 text-sm hover:bg-gray-600" role="menuitem" tabindex="-1" data-id="${item.id}" data-type="${typeData}" data-new-status="${step}">${step}</a>`).join('')}
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </td>`;
                }
                
                // NEW: View Details icon
                const viewDetailsIcon = `<button class="action-btn text-blue-500 hover:text-blue-700" data-action="view-details" data-id="${item.id}" data-type="${type}" title="View Details"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>`;


                return `
                <tr class="bg-gray-800/50 border-b border-gray-700 hover:bg-gray-700/70 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${item.propertyNumber || ''}</td>
                    ${renderPhaseColumn ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.phase || ''}</td>` : ''}
                    ${isCivilDefence ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatDate(item.issueDate)}</td>` : ''}
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatDate(item.expiryDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${generateStatusBadge(validityStatus)}</td>
                    ${isAman ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.deviceId || ''}</td>` : ''}
                    ${isAman ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.serialNumber || ''}</td>` : ''}
                    ${workflowCell}
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center justify-end space-x-2">
                        ${isEditor ? updateStatusButton : ''}
                        ${isEditor ? renewalButton : ''} <!-- RENEWAL BUTTON (Admin Only) -->
                        ${viewDetailsIcon} <!-- VIEW DETAILS BUTTON (Always visible) -->
                        <button class="action-btn text-purple-400 hover:text-purple-300" data-action="history" data-id="${item.id}" title="View History"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
                        ${isEditor ? `<button class="action-btn text-teal-400 hover:text-teal-300" data-action="edit" data-id="${item.id}" data-type="${type}" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg></button>` : ''}
                        ${isEditor ? `<button class="action-btn text-red-500 hover:text-red-400" data-action="delete" data-id="${item.id}" data-type="${type}" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg></button>` : ''}
                    </td>
                </tr>
                `}).join('');
        }
        
        function generateStatusBadge(status) {
            // Note: Keeping badges dark-themed as they look best this way against light backgrounds too.
            const colors = { green: "bg-green-500/20 text-green-400 border border-green-500/30", yellow: "bg-yellow-500/20 text-yellow-400 border border-yellow-500/30", red: "bg-red-500/20 text-red-400 border border-red-500/30", gray: "bg-gray-500/20 text-gray-400 border border-gray-500/30" };
            return `<span class="px-3 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${colors[status.color]}">${status.text}</span>`;
        }
        
        function generateWorkflowBadge(status, inspectionDate, type) {
            const cdColors = {	
                'Renewal Pending': "bg-red-500/20 text-red-400 border-red-500/30",
                'Informed Fire team': "bg-orange-500/20 text-orange-400 border-orange-500/30",
                'Awaiting inspection': "bg-yellow-500/20 text-yellow-400 border-yellow-500/30",
                'Inspection Date': "bg-blue-500/20 text-blue-400 border-blue-500/30",
                'Certificate ready': "bg-cyan-500/20 text-cyan-400 border-cyan-500/30",
                'AMC ready': "bg-purple-500/20 text-purple-400 border-purple-500/30",
            };

            const amanColors = {
                'Installation in Progress': "bg-yellow-500/20 text-yellow-400 border-yellow-500/30",
                'Pending Renewal': "bg-red-500/20 text-red-400 border-red-500/30",
                'Certificate ready': "bg-cyan-500/20 text-cyan-400 border-cyan-500/30",
            };

            const colors = type === 'Civil Defence' ? cdColors : amanColors;

            let text = status || 'N/A';
            if (status === 'Inspection Date' && inspectionDate) {
                text = `Inspection: ${formatDate(inspectionDate)}`;
            }

            return `<span class="px-3 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${colors[status] || 'bg-gray-500/20 text-gray-400 border-gray-500/30'}">${text}</span>`;
        }

        // --- Modals and Forms ---
        function showModal(title, content, onOpen = null) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-lg m-4 max-h-[90vh] flex flex-col">
                    <div class="flex items-center justify-between p-5 border-b border-gray-700 flex-shrink-0">
                        <h3 class="text-xl font-bold text-white">${title}</h3>
                        <button id="modal-close-btn" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto">${content}</div>
                </div>`;
            modalContainer.classList.remove('hidden');
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);
            if(onOpen) onOpen();
        }

        function hideModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            modalContainer.classList.add('hidden');
        }

        // --- FIX: Add/Edit Form Modal ---
        function handleShowForm(type, id = null) {
            const isEdit = !!id;
            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            const cert = isEdit ? dataArray.find(c => c.id === id) : {};
            
            // Default values for new entries
            const defaults = {
                propertyNumber: '', phase: 'Phase 1', propertyType: 'warehouse',
                issueDate: '', expiryDate: '', notes: '', workflowStatus: '',
                amcOnly: false, certificateLink: '', inspectionDate: '',
                // Aman specific
                accountId: '', recordId: '', deviceId: '', serialNumber: ''
            };

            const formData = isEdit ? cert : defaults;

            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';
            const workflowSteps = isCivilDefence ? CD_WORKFLOW_STEPS : AMAN_WORKFLOW_STEPS;
            
            // Function to normalize stored/default property type to one of the canonical keys (warehouse, opy, admin, others)
            const normalizePropertyType = (typeValue) => {
                const lower = String(typeValue || '').toLowerCase().replace(/\s/g, '');
                if (lower.includes('warehouse')) return 'warehouse';
                if (lower.includes('opy') || lower.includes('openyard')) return 'opy';
                if (lower.includes('admin') || lower.includes('adminbuilding')) return 'admin';
                return 'others';
            };

            const normalizedCurrentType = normalizePropertyType(formData.propertyType);

            // Options for Property Type dropdown (Display Label => Stored Value)
            // FIX: Changed 'Admin' stored value to 'admin building' as requested.
            const propertyTypeOptions = {
                'Warehouse': 'warehouse', 
                'OPY': 'opy', 
                'Admin': 'admin building', 
                'Others': 'others'
            };

            // --- Aman Menu (Floating: Three-dot icon) ---
            const amanMenuHtml = isAman && isEdit ? `
                <div class="absolute -top-6 right-0 z-10">
                    <button type="button" id="aman-history-menu-btn" class="p-2 rounded-full text-gray-400 hover:bg-gray-700/50 hover:text-white transition-colors" title="Financial Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                    </button>
                    <div id="aman-history-dropdown-${id}" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-gray-700 ring-1 ring-black ring-opacity-5 hidden">
                        <div class="py-1">
                            <button type="button" data-action="edit-financial" data-id="${id}" class="aman-menu-option flex items-center w-full px-4 py-2 text-sm text-yellow-300 hover:bg-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                Edit Financial Records
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            // --- Civil Defence Date Arrangement (Issue Date and Expiry Date in one row) ---
            const cdDateFields = isCivilDefence ? `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="issueDate" class="block text-sm font-medium text-gray-300 mb-2">Issue Date</label>
                        <input type="date" id="issueDate" name="issueDate" value="${formData.issueDate || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="expiryDate" class="block text-sm font-medium text-gray-300 mb-2">Expiry Date</label>
                        <input type="date" id="expiryDate" name="expiryDate" value="${formData.expiryDate || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                    </div>
                </div>
            ` : `
                <!-- Fallback for Aman/New: Expiry Date stays single -->
                <div>
                    <label for="expiryDate" class="block text-sm font-medium text-gray-300 mb-2">Expiry Date</label>
                    <input type="date" id="expiryDate" name="expiryDate" value="${formData.expiryDate || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                </div>
            `;


            const commonFields = `
                <input type="hidden" name="id" value="${formData.id || ''}">
                <input type="hidden" name="project" value="${formData.project || currentProject}">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="propertyNumber" class="block text-sm font-medium text-gray-300 mb-2">Property Number *</label>
                        <input type="text" id="propertyNumber" name="propertyNumber" value="${formData.propertyNumber || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500" required>
                    </div>
                    ${isCivilDefence ? '' : cdDateFields} <!-- If not CD, display single expiry input here -->
                </div>
                
                ${amanMenuHtml} <!-- Repositioned Aman Menu to be slightly above date inputs -->

                ${isCivilDefence ? cdDateFields : ''} <!-- If CD, display dual date row here -->

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- FIX 4: Phase Field container with visibility logic. Initial check uses the normalized property type. -->
                    <div id="phase-field-container" class="${(normalizedCurrentType === 'warehouse') ? '' : 'hidden'}">
                        <label for="phase" class="block text-sm font-medium text-gray-300 mb-2">Phase</label>
                        <!-- FIX 2: Removed disabledProp -->
                        <select id="phase" name="phase" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                            ${['Phase 1', 'Phase 2', 'OPY', 'Other'].map(p => `<option value="${p}" ${formData.phase === p ? 'selected' : ''}>${p}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="propertyType" class="block text-sm font-medium text-gray-300 mb-2">Property Type</label>
                        <!-- FIX 2: Removed disabledProp -->
                        <select id="propertyType" name="propertyType" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                            ${Object.keys(propertyTypeOptions).map(display => {
                                const storedValue = propertyTypeOptions[display];
                                
                                // FIX: Use the general rule to check if this option corresponds to the item's normalized type.
                                const isSelected = normalizePropertyType(storedValue) === normalizedCurrentType;
                                
                                return `<option value="${storedValue}" ${isSelected ? 'selected' : ''}>${display}</option>`;
                            }).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="workflowStatus" class="block text-sm font-medium text-gray-300 mb-2">Workflow Status</label>
                        <select id="workflowStatus" name="workflowStatus" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                            ${workflowSteps.map(step => `<option value="${step}" ${formData.workflowStatus === step ? 'selected' : ''}>${step}</option>`).join('')}
                        </select>
                    </div>
                    ${(isCivilDefence && formData.workflowStatus === 'Inspection Date') ? `
                    <div>
                        <label for="inspectionDate" class="block text-sm font-medium text-gray-300 mb-2">Inspection Date</label>
                        <input type="date" id="inspectionDate" name="inspectionDate" value="${formData.inspectionDate || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                    </div>` : '<div></div>'}
                    
                    ${isCivilDefence ? `
                    <div class="flex items-center pt-8">
                        <input type="checkbox" id="amcOnly" name="amcOnly" class="h-4 w-4 text-teal-600 border-gray-600 rounded bg-gray-900 focus:ring-teal-500" ${formData.amcOnly === 'on' || formData.amcOnly === true ? 'checked' : ''}>
                        <label for="amcOnly" class="ml-2 block text-sm font-medium text-gray-300">AMC Only (No Expiry)</label>
                    </div>
                    ` : ''}

                    ${isAman ? `
                    <div>
                        <label for="accountId" class="block text-sm font-medium text-gray-300 mb-2">Account ID</label>
                        <input type="text" id="accountId" name="accountId" value="${formData.accountId || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="recordId" class="block text-sm font-medium text-gray-300 mb-2">Record ID</label>
                        <input type="text" id="recordId" name="recordId" value="${formData.recordId || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="deviceId" class="block text-sm font-medium text-gray-300 mb-2">Device ID</label>
                        <input type="text" id="deviceId" name="deviceId" value="${formData.deviceId || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="serialNumber" class="block text-sm font-medium text-gray-300 mb-2">Serial Number</label>
                        <input type="text" id="serialNumber" name="serialNumber" value="${formData.serialNumber || ''}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                    </div>
                    ` : ''}
                </div>

                <div class="col-span-full">
                    <label for="certificateLink" class="block text-sm font-medium text-gray-300 mb-2">Certificate PDF Link / Storage Path</label>
                    <input type="url" id="certificateLink" name="certificateLink" value="${formData.certificateLink || ''}" placeholder="e.g., https://docs.google.com/..." class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">
                </div>

                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-300 mb-2">Notes</label>
                    <textarea id="notes" name="notes" rows="3" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500">${formData.notes || ''}</textarea>
                </div>
                
                
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="form-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">${isEdit ? 'Update Certificate' : 'Add Certificate'}</button>
                </div>
            `;

            const formContent = `<form id="cert-form-${type.replace(/\s/g, '-')}" class="space-y-4 relative" data-id="${id || ''}" data-type="${type}">${commonFields}</form>`;

            showModal(`${isEdit ? 'Edit' : 'Add New'} ${type}`, formContent, () => {
                const formEl = document.getElementById(`cert-form-${type.replace(/\s/g, '-')}`);
                const propertyTypeSelect = document.getElementById('propertyType');
                const phaseFieldContainer = document.getElementById('phase-field-container');
                const phaseSelect = document.getElementById('phase');


                // FIX 4: Added event listener to propertyType to toggle Phase visibility
                if (propertyTypeSelect) {
                    propertyTypeSelect.addEventListener('change', (e) => {
                        const newType = e.target.value;
                        // Check for 'warehouse' using standardized value
                        const isWarehouse = normalizePropertyType(newType) === 'warehouse'; 
                        phaseFieldContainer.classList.toggle('hidden', !isWarehouse);
                        
                        // If switching away from warehouse, clear phase to prevent confusion
                        if (!isWarehouse && phaseSelect) {
                            phaseSelect.value = 'Other'; 
                        }
                    });
                }
                
                // PASS CONTEXT TO GLOBAL HANDLER
                formEl.addEventListener('submit', (e) => handleSave(e, type, id));
                document.getElementById('form-cancel-btn').addEventListener('click', hideModal);
                
                // Aman Menu Toggle Logic
                if (isAman && isEdit) {
                    const menuBtn = document.getElementById('aman-history-menu-btn');
                    const menuDropdown = document.getElementById(`aman-history-dropdown-${id}`);

                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        menuDropdown.classList.toggle('hidden');
                    });
                    
                    // Handle clicking outside the dropdown to close it
                    document.addEventListener('click', (e) => {
                        if (e.target.closest('#modal-container') && !menuDropdown.contains(e.target) && e.target !== menuBtn) {
                            menuDropdown.classList.add('hidden');
                        }
                    });

                    // Listener for the menu option
                    formEl.querySelector('.aman-menu-option[data-action="edit-financial"]').addEventListener('click', () => {
                        hideModal(); // Close the main edit modal
                        handleShowAmanHistoryModal(id); // Open the dedicated cost management modal
                    });
                }

                // Dynamic re-render logic for inspection date field visibility
                const workflowSelect = document.getElementById('workflowStatus');
                if (workflowSelect) {
                    workflowSelect.addEventListener('change', () => {
                        // Preserve the now-editable phase and propertyType values before re-rendering
                        formData.phase = document.getElementById('phase') ? document.getElementById('phase').value : 'Other'; // Handle potentially hidden field
                        formData.propertyType = document.getElementById('propertyType').value;
                        
                        hideModal(); // Hide and reopen to re-render the Inspection Date field if needed
                        handleShowForm(type, id);
                    });
                }
            });
        }
        
        // --- FIX: History Modal (Expiry/Link History) ---
        function handleShowHistoryModal(id) {
            const history = historyData[id] || [];
            const cert = cdCerts.find(c => c.id === id) || amanCerts.find(c => c.id === id);

            if (!cert) return showModal("Error", `<p class='text-red-400'>Certificate data not found for ID: ${id}</p>`);
            
            // Reverse the history array to show most recent old entry first
            const sortedHistory = [...history].sort((a, b) => new Date(b.archivedAt) - new Date(a.archivedAt));

            const historyItemsHtml = sortedHistory.length > 0 ? sortedHistory.map((item, index) => {
                const timestamp = new Date(item.archivedAt).toLocaleString('en-GB');
                const linkHtml = item.certificateLink ? `
                    <a href="${item.certificateLink}" target="_blank" rel="noopener noreferrer" class="text-xs text-teal-400 hover:text-teal-300 underline flex items-center gap-1 mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        View Archived Link
                    </a>` : `<p class="text-xs text-gray-500 mt-2">No archived link recorded.</p>`;

                return `
                    <div class="p-4 rounded-lg border border-gray-700 ${index === 0 ? 'bg-gray-700/50' : 'bg-gray-800/50'}">
                        <p class="text-sm font-bold text-white mb-2">Archived Expiry: <span class="text-red-400">${formatDate(item.expiryDate)}</span></p>
                        <p class="text-xs text-gray-400">Date Logged: ${timestamp}</p>
                        ${linkHtml}
                        <div class="mt-2 pt-2 border-t border-gray-600">
                            <p class="text-xs text-gray-400">Archived Workflow Status: ${item.workflowStatus || 'N/A'}</p>
                        </div>
                    </div>
                `;
            }).join('')
            : `<p class="text-center py-6 text-gray-400">No previous expiry/link history found for this certificate.</p>`;


            const modalContent = `
                <h4 class="text-lg font-bold text-white mb-4 border-b border-gray-700 pb-2">Current Expiry: <span class="text-teal-400">${formatDate(cert.expiryDate)}</span></h4>
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    ${historyItemsHtml}
                </div>
                <div class="flex justify-end pt-6">
                    <button onclick="hideModal()" class="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold">Close</button>
                </div>
            `;

            showModal(`History for ${cert.propertyNumber}`, modalContent);
        }

        // --- FIX: Handle Inspection Status Update ---
        function handleUpdateInspectionStatus(id) {
            const certIndex = cdCerts.findIndex(c => c.id === id);
            if (certIndex !== -1) {
                // Change workflow from Inspection Date (past or today) to Certificate ready
                // User is assumed to perform this manually after inspection confirmation
                showModal("Inspection Complete?", "<p class='text-gray-300'>The inspection for this property was due/completed. Are you setting the status to 'Certificate ready'?</p><div class='flex justify-end gap-4 mt-6'><button id='confirm-status-update' class='px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-500 transition-colors font-semibold'>Set Ready</button><button id='cancel-status-update' class='px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold'>Cancel</button></div>", () => {
                    document.getElementById('confirm-status-update').addEventListener('click', () => {
                        cdCerts[certIndex].workflowStatus = 'Certificate ready';
                        cdCerts[certIndex].inspectionDate = '';
                        saveDataToFirebase();
                        hideModal();
                        render();
                    });
                    document.getElementById('cancel-status-update').addEventListener('click', hideModal);
                });
            }
        }

        
        // --- Aman Cost History Functions ---
        
        function calculateAmanCosts(cert) {
            const history = cert.renewalHistory || [];
            let totalInstallation = 0;
            let totalRenewal = 0;

            history.forEach(record => {
                const cost = parseFloat(record.cost) || 0;
                if (record.type === 'Installation') {
                    totalInstallation += cost;
                } else if (record.type === 'Renewal') {
                    totalRenewal += cost;
                }
            });

            return { totalInstallation, totalRenewal, totalLifetime: totalInstallation + totalRenewal };
        }

        function handleShowAmanHistoryModal(id) {
            const cert = amanCerts.find(c => c.id === id);
            if (!cert) return showModal("Error", "<p class='text-red-400'>Certificate not found.</p>");

            const renderHistoryForm = () => {
                const history = cert.renewalHistory || [];
                const installationRecord = history.find(r => r.type === 'Installation') || { id: crypto.randomUUID(), type: 'Installation', date: '', cost: '' };
                const renewalRecords = history.filter(r => r.type === 'Renewal').sort((a,b) => new Date(b.date) - new Date(a.date));
                const costs = calculateAmanCosts(cert);

                const renewalListHtml = renewalRecords.map((record, index) => `
                    <div class="flex items-center space-x-2 bg-gray-700/50 p-3 rounded-lg mb-2" data-id="${record.id}">
                        <input type="date" value="${record.date}" required class="renewal-date w-1/3 bg-gray-900 border border-gray-600 rounded-lg px-2 py-1 text-white text-sm">
                        <input type="number" step="0.01" value="${record.cost}" required placeholder="Cost (AED)" class="renewal-cost w-1/3 bg-gray-900 border border-gray-600 rounded-lg px-2 py-1 text-white text-sm">
                        <span class="text-gray-400 text-sm w-1/4">Renewal #${renewalRecords.length - index}</span>
                        <button type="button" class="remove-renewal-btn text-red-500 hover:text-red-400 p-1" data-id="${record.id}">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>
                        </button>
                    </div>
                `).join('');

                return `
                    <div class="mb-4 grid grid-cols-3 gap-2 p-3 bg-teal-900/40 rounded-lg">
                        <div class="col-span-1 text-teal-300 font-semibold">Total Install:</div>
                        <div class="col-span-2 text-white font-bold text-right">${costs.totalInstallation.toFixed(2)} AED</div>
                        <div class="col-span-1 text-teal-300 font-semibold">Total Renewal:</div>
                        <div class="col-span-2 text-white font-bold text-right">${costs.totalRenewal.toFixed(2)} AED</div>
                        <div class="col-span-1 text-teal-300 font-semibold border-t border-teal-700 pt-2">Lifetime Cost:</div>
                        <div class="col-span-2 text-white font-bold text-right border-t border-teal-700 pt-2">${costs.totalLifetime.toFixed(2)} AED</div>
                    </div>

                    <form id="aman-history-form" data-id="${id}" class="space-y-6">
                        <h4 class="text-lg font-bold text-white border-b border-gray-700 pb-2">Initial Installation Record</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="hidden" name="id" value="${installationRecord.id}">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Installation Date</label>
                                <input type="date" id="installDate" name="installDate" value="${installationRecord.date}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Installation Cost (AED)</label>
                                <input type="number" step="0.01" id="installCost" name="installCost" value="${installationRecord.cost}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="Cost in AED" required>
                            </div>
                        </div>

                        <h4 class="text-lg font-bold text-white border-b border-gray-700 pb-2 flex justify-between items-center">
                            Renewal Records
                            <button type="button" id="add-renewal-btn" class="text-teal-400 hover:text-teal-300 text-sm font-medium flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg> Add Renewal
                            </button>
                        </h4>
                        <div id="renewal-records-list">
                            ${renewalListHtml || '<p class="text-gray-400 text-center py-4">No renewal records yet.</p>'}
                        </div>
                        
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Save History</button>
                        </div>
                    </form>
                `;
            };

            showModal(`Edit Aman History for ${cert.propertyNumber}`, renderHistoryForm(), () => {
                document.getElementById('aman-history-form').addEventListener('submit', (e) => handleSaveHistory(e, cert.id));
                document.getElementById('add-renewal-btn').addEventListener('click', () => addEmptyRenewalRecord(cert.id));
                document.getElementById('renewal-records-list').addEventListener('click', (e) => {
                    if (e.target.closest('.remove-renewal-btn')) {
                        removeRenewalRecord(e.target.closest('.remove-renewal-btn').dataset.id, cert.id);
                    }
                });
            });
        }
        
        function addEmptyRenewalRecord(certId) {
            const listEl = document.getElementById('renewal-records-list');
            const newId = crypto.randomUUID();
            const newRecordHtml = `
                <div class="flex items-center space-x-2 bg-gray-700/50 p-3 rounded-lg mb-2 new-record" data-id="${newId}">
                    <input type="date" value="" required class="renewal-date w-1/3 bg-gray-900 border border-gray-600 rounded-lg px-2 py-1 text-white text-sm">
                    <input type="number" step="0.01" value="" required placeholder="Cost (AED)" class="renewal-cost w-1/3 bg-gray-900 border border-gray-600 rounded-lg px-2 py-1 text-white text-sm">
                    <span class="text-gray-400 text-sm w-1/4">New Renewal</span>
                    <button type="button" class="remove-renewal-btn text-red-500 hover:text-red-400 p-1" data-id="${newId}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>
                    </button>
                </div>
            `;
            listEl.insertAdjacentHTML('afterbegin', newRecordHtml);
            // Remove the 'No records' placeholder if present
            const placeholder = listEl.querySelector('p');
            if (placeholder && placeholder.textContent.includes('No renewal')) placeholder.remove();
        }

        function removeRenewalRecord(recordId, certId) {
            const certIndex = amanCerts.findIndex(c => c.id === certId);
            if (certIndex === -1) return;

            amanCerts[certIndex].renewalHistory = amanCerts[certIndex].renewalHistory.filter(r => r.id !== recordId);
            saveDataToFirebase();
            // Re-render the history modal content
            hideModal();
            handleShowAmanHistoryModal(certId);
        }

        function handleSaveHistory(e, id) {
            e.preventDefault();
            const certIndex = amanCerts.findIndex(c => c.id === id);
            if (certIndex === -1) return;

            const newHistory = [];
            
            // 1. Handle Installation Record
            const installDate = document.getElementById('installDate').value;
            const installCost = parseFloat(document.getElementById('installCost').value);
            const installId = e.target.querySelector('input[name="id"]').value;

            if (installDate && !isNaN(installCost)) {
                newHistory.push({
                    id: installId,
                    type: 'Installation',
                    date: installDate,
                    cost: installCost
                });
            } else {
                 showModal("Validation Error", "<p class='text-red-400'>Installation Date and Cost are required.</p>");
                 return;
            }

            // 2. Handle Renewal Records
            const renewalRecords = document.getElementById('renewal-records-list').children;
            let validationFailed = false;

            Array.from(renewalRecords).forEach(el => {
                if (el.tagName === 'DIV') {
                    const dateInput = el.querySelector('.renewal-date');
                    const costInput = el.querySelector('.renewal-cost');
                    const recordId = el.dataset.id;
                    
                    const date = dateInput ? dateInput.value : '';
                    const cost = costInput ? parseFloat(costInput.value) : NaN;

                    if (date && !isNaN(cost)) {
                        newHistory.push({
                            id: recordId,
                            type: 'Renewal',
                            date: date,
                            cost: cost
                        });
                    } else if (date || !isNaN(cost)) {
                        // Partial entry found
                        validationFailed = true;
                    }
                }
            });

            if(validationFailed) {
                 showModal("Validation Error", "<p class='text-red-400'>All renewal entries must have both a Date and a Cost.</p>");
                 return;
            }
            
            amanCerts[certIndex].renewalHistory = newHistory;
            saveDataToFirebase();
            hideModal();
            render(); // Re-render table and details

            showModal("Success", `<p class='text-green-400'>Aman cost history for ${amanCerts[certIndex].propertyNumber} saved successfully.</p>`);
        }
        
        // Handle Show Details Modal
        function handleShowDetailsModal(id, type) {
            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            const cert = dataArray.find(c => c.id === id);
            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';
            
            if (!cert) return showModal("Error", "<p class='text-red-400'>Certificate not found.</p>");
            
            const costs = isAman ? calculateAmanCosts(cert) : {};

            const detailsMap = [
                { label: 'Property Number', value: cert.propertyNumber },
                { label: 'Project', value: cert.project || 'Main Project' },
                { label: 'Phase', value: cert.phase || 'N/A' },
                { label: 'Type', value: cert.propertyType ? cert.propertyType.toUpperCase() : 'N/A' },
                { label: 'Validity Status', value: generateStatusBadge(getValidityStatus(cert.expiryDate)), html: true },
                { label: 'Expiry Date', value: formatDate(cert.expiryDate) },
                { label: 'Workflow Status', value: generateWorkflowBadge(cert.workflowStatus, cert.inspectionDate, type), html: true },
            ];

            if (isCivilDefence) {
                detailsMap.splice(5, 0, { label: 'Issue Date', value: formatDate(cert.issueDate) });
                detailsMap.push({ label: 'AMC Only', value: cert.amcOnly === 'on' || cert.amcOnly === true ? 'Yes' : 'No' });
            }
            if (isAman) {
                detailsMap.push({ label: 'Account ID', value: cert.accountId || 'N/A' });
                detailsMap.push({ label: 'Record ID', value: cert.recordId || 'N/A' });
                detailsMap.push({ label: 'Device ID', value: cert.deviceId || 'N/A' });
                detailsMap.push({ label: 'Serial Number', value: cert.serialNumber || 'N/A' });
            }
            detailsMap.push({ label: 'Notes', value: cert.notes || 'N/A', fullWidth: true });

            const detailsHtml = detailsMap.map(detail => `
                <div class="${detail.fullWidth ? 'md:col-span-2' : 'col-span-1'} p-3 bg-gray-700/50 rounded-lg">
                    <p class="text-xs font-semibold text-gray-400">${detail.label}</p>
                    <p class="text-sm font-medium text-white mt-1">
                        ${detail.html ? detail.value : (detail.value || 'N/A')}
                    </p>
                </div>
            `).join('');
            
            const costHtml = isAman ? `
                <div class="md:col-span-2 mt-6">
                    <h4 class="text-lg font-bold text-yellow-400 mb-3">Cost Summary (AED)</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="p-3 bg-gray-700/50 rounded-lg text-center">
                            <p class="text-xs font-semibold text-gray-400">Total Installation</p>
                            <p class="text-sm font-bold text-white">${costs.totalInstallation.toFixed(2)}</p>
                        </div>
                        <div class="p-3 bg-gray-700/50 rounded-lg text-center">
                            <p class="text-xs font-semibold text-gray-400">Total Renewal</p>
                            <p class="text-sm font-bold text-white">${costs.totalRenewal.toFixed(2)}</p>
                        </div>
                        <div class="p-3 bg-teal-700/50 rounded-lg text-center">
                            <p class="text-xs font-semibold text-teal-300">Total Lifetime</p>
                            <p class="text-sm font-bold text-white">${costs.totalLifetime.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            ` : '';


            const certificateButton = cert.certificateLink ? `
                <div class="md:col-span-2 mt-6">
                    <h4 class="text-lg font-bold text-teal-400 mb-3">Linked Document</h4>
                    <a href="${cert.certificateLink}" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-3 px-6 py-3 rounded-lg bg-teal-600 hover:bg-teal-500 transition-colors text-white font-bold shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="10" y1="13" x2="14" y2="13"></line><line x1="10" y1="17" x2="14" y2="17"></line><line x1="10" y1="9" x2="10" y2="9"></line></svg>
                        View Certificate PDF
                    </a>
                    <p class="text-xs text-gray-400 mt-2 text-center">Clicking the button opens the PDF link you provided in a new tab.</p>
                </div>
            ` : `<p class="md:col-span-2 mt-4 text-center text-yellow-400">No certificate PDF link provided for this entry.</p>`;

            const modalContent = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${detailsHtml}
                    ${costHtml}
                    ${certificateButton}
                </div>
            `;
            
            showModal(`${type} Details: ${cert.propertyNumber}`, modalContent);
        }

        // --- Renewal Modal ---

        function handleShowRenewalModal(type, id) {
            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            const cert = dataArray.find(c => c.id === id);
            if (!cert) return showModal("Error", "<p class='text-red-400'>Certificate not found.</p>");
            
            const isCivilDefence = type === 'Civil Defence';
            const isAman = type === 'Aman Certificate';
            const validityStatus = getValidityStatus(cert.expiryDate);

            const renewalFieldsHtml = isAman ? `
                <h3 class="text-lg font-bold text-yellow-400 mb-4 border-b border-gray-700 pb-2">Aman Financial Details (Renewal Payment)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="renewalDate" class="block text-sm font-medium text-gray-300 mb-2">Renewal/Payment Date</label>
                        <input type="date" id="renewalDate" name="renewalDate" required class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label for="renewalCost" class="block text-sm font-medium text-gray-300 mb-2">Renewal Cost (AED)</label>
                        <input type="number" step="0.01" id="renewalCost" name="renewalCost" required class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="Amount in AED">
                    </div>
                </div>
            ` : '';
            
            // NEW: Issue Date field for CD renewals
            const cdIssueDateInput = isCivilDefence ? `
                <div class="pt-4">
                    <label for="newIssueDate" class="block text-sm font-medium text-gray-300 mb-2">New Certificate Issue Date</label>
                    <input type="date" id="newIssueDate" name="newIssueDate" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white">
                </div>
            ` : '';


            const modalContent = `
                <form id="renewal-form" data-id="${id}" data-type="${type}" class="space-y-6">
                    <p class="text-lg font-medium text-gray-300">Renewing <span class="text-teal-400">${cert.propertyNumber}</span> (Current Status: ${validityStatus.text})</p>
                    
                    <h3 class="text-lg font-bold text-white mb-4 border-b border-gray-700 pb-2">New Certificate Details</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="newExpiryDate" class="block text-sm font-medium text-gray-300 mb-2">New Expiry Date</label>
                            <input type="date" id="newExpiryDate" name="newExpiryDate" required class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white">
                        </div>
                        ${cdIssueDateInput}
                    </div>
                    
                    ${renewalFieldsHtml}

                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="renewal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold">Cancel</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Confirm Renewal</button>
                    </div>
                </form>
            `;

            showModal(`Renew ${type} Certificate`, modalContent, () => {
                document.getElementById('renewal-form').addEventListener('submit', handleProcessRenewal);
                document.getElementById('renewal-cancel-btn').addEventListener('click', hideModal);
            });
        }

        function handleProcessRenewal(e) {
            e.preventDefault();
            const form = e.target;
            const id = form.dataset.id;
            const type = form.dataset.type;
            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            const certIndex = dataArray.findIndex(c => c.id === id);

            if (certIndex === -1) return;

            const newExpiryDate = document.getElementById('newExpiryDate').value;
            if (!newExpiryDate) {
                showModal("Validation Error", "<p class='text-red-400'>New Expiry Date is mandatory.</p>");
                return;
            }

            const cert = dataArray[certIndex];
            
            // 1. Log Old Expiry/Link to HistoryData before renewal
            if (!historyData[id]) historyData[id] = [];
            historyData[id].push({	
                ...cert,	
                archivedAt: new Date().toISOString(),
                // Keep only relevant historical fields to save space
                // FIX: Ensure no undefined values for Firebase set()
                expiryDate: cert.expiryDate || '',
                certificateLink: cert.certificateLink || ''
            });


            // 2. Update Main Certificate Data
            cert.expiryDate = newExpiryDate;
            cert.workflowStatus = 'Certificate ready';
            cert.inspectionDate = ''; // Clear inspection date if renewal
            
            // 2b. Handle Civil Defence Issue Date update
            if (type === 'Civil Defence') {
                const newIssueDate = document.getElementById('newIssueDate').value;
                if (newIssueDate) {
                    cert.issueDate = newIssueDate;
                }
            }
            
            // 3. Handle Aman Financial History
            if (type === 'Aman Certificate') {
                const renewalDate = document.getElementById('renewalDate').value;
                const renewalCost = parseFloat(document.getElementById('renewalCost').value);

                if (!renewalDate || isNaN(renewalCost) || renewalCost < 0) {
                     showModal("Validation Error", "<p class='text-red-400'>Renewal Date and Cost are required for Aman certificates.</p>");
                     return;
                }
                
                // Add new Renewal record to renewalHistory
                cert.renewalHistory.push({
                    id: crypto.randomUUID(),
                    type: 'Renewal',
                    date: renewalDate,
                    cost: renewalCost
                });
            }

            // 4. Save and Finish
            saveDataToFirebase();
            hideModal();
            render();
            showModal("Renewal Complete", `<p class='text-green-400'>Certificate for ${cert.propertyNumber} has been successfully renewed until ${formatDate(newExpiryDate)}!</p>`);
        }
        
        // --- Financial Report Options Modal ---
        function handleShowFinancialReportOptions() {
             const modalContent = `
                <p class="text-gray-300 mb-6">Select the format for the Aman Financial History Report:</p>
                <div class="grid grid-cols-2 gap-4">
                    <button id="download-pdf-btn" class="flex flex-col items-center justify-center p-4 rounded-lg bg-teal-600 hover:bg-teal-500 text-white font-bold transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mb-2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="17" x2="12" y2="17"></line></svg>
                        Download PDF (Vertical Stack)
                    </button>
                    <button id="download-csv-btn" class="flex flex-col items-center justify-center p-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mb-2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><path d="M15 3v4a2 2 0 0 0 2 2h4"></path><path d="M10 12h-4"></path><path d="M8 8l-2 4 2 4"></path></svg>
                        Export Excel (Horizontal)
                    </button>
                </div>`;
            
            showModal('Financial Report Options', modalContent, () => {
                const filteredAmanCerts = amanCerts.filter(c => (c.project || 'Main Project') === currentProject);
                document.getElementById('download-pdf-btn').addEventListener('click', () => {
                    hideModal();
                    handleDownloadFinancialReport('Aman Certificate', filteredAmanCerts);
                });
                document.getElementById('download-csv-btn').addEventListener('click', () => {
                    hideModal();
                    handleExportFinancialDataCSV('Aman Certificate', filteredAmanCerts);
                });
            });
        }


        function handleExportFinancialDataCSV(type, data) {
            if (type !== 'Aman Certificate') return;

            const filteredData = data.filter(item => (item.project || 'Main Project') === currentProject);
            
            if (filteredData.length === 0) {
                showModal("Export Failed", "<p class='text-yellow-400'>No data to export based on the current filters.</p>");
                return;
            }

            // 1. Determine Max Renewals for dynamic header generation
            const maxRenewals = filteredData.reduce((max, item) => {
                const renewals = (item.renewalHistory || []).filter(r => r.type === 'Renewal').length;
                return Math.max(max, renewals);
            }, 0);

            // 2. Build Header
            const fixedHeaders = ['Property Number', 'Expiry Date', 'Account ID', 'Install Date', 'Install Cost (AED)'];
            const dynamicHeaders = [];
            for (let i = 1; i <= maxRenewals; i++) {
                dynamicHeaders.push(`R${i} Date`, `R${i} Cost (AED)`);
            }
            const headers = [...fixedHeaders, ...dynamicHeaders, 'Total Install Cost', 'Total Renewal Cost', 'Total Lifetime Cost'];
            
            let csvContent = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
            
            // 3. Build Body
            filteredData.forEach(item => {
                const history = item.renewalHistory || [];
                const installRecord = history.find(r => r.type === 'Installation') || {};
                const renewalRecords = history.filter(r => r.type === 'Renewal').sort((a,b) => new Date(a.date) - new Date(b.date));
                const costs = calculateAmanCosts(item);

                const rowData = [];

                // Fixed Columns
                rowData.push(item.propertyNumber || '');
                rowData.push(item.expiryDate ? formatDate(item.expiryDate) : 'N/A');
                rowData.push(item.accountId || 'N/A');
                rowData.push(installRecord.date ? formatDate(installRecord.date) : 'N/A');
                rowData.push(installRecord.cost !== undefined ? parseFloat(installRecord.cost).toFixed(2) : '0.00');

                // Dynamic Renewal Columns
                for (let i = 1; i <= maxRenewals; i++) {
                    const renewal = renewalRecords[i - 1];
                    if (renewal) {
                        rowData.push(formatDate(renewal.date));
                        rowData.push(parseFloat(renewal.cost).toFixed(2));
                    } else {
                        rowData.push('', ''); // Empty slots to match maxRenewals columns
                    }
                }
                
                // Summary Columns
                rowData.push(costs.totalInstallation.toFixed(2));
                rowData.push(costs.totalRenewal.toFixed(2));
                rowData.push(costs.totalLifetime.toFixed(2));

                csvContent += rowData.map(d => `"${String(d).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            // 4. Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Aman_Financial_Report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function handleDownloadFinancialReport(type, data) {
            if (type !== 'Aman Certificate') return;	

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');	
            
            // --- Filtering Data (Done in the options modal trigger, but filtering again for safety based on local state) ---
            const filters = currentFilters[type];
            const getLower = (item, field) => String(item[field] || '').toLowerCase();
            
            const filteredData = data.filter(item => {
                const validityMatch = filters.validity === 'All' || getValidityStatus(item.expiryDate).text === filters.validity;
                let searchMatch = !filters.search;
                if(filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm)) ||
                                        (getLower(item, 'accountId').includes(searchTerm)) ||
                                        (getLower(item, 'recordId').includes(searchTerm)) ||
                                        (getLower(item, 'deviceId').includes(searchTerm)) ||	
                                        (getLower(item, 'serialNumber').includes(searchTerm));	
                }
                const phaseMatch = filters.phase === 'All' || item.phase === filters.phase;
                const workflowMatch = filters.workflow === 'All' || item.workflowStatus === filters.workflow;
                return validityMatch && searchMatch && phaseMatch && workflowMatch;
            });

            if (filteredData.length === 0) {
                showModal("Report Generation Failed", "<p class='text-yellow-400'>No Aman data matching current filters to generate the financial report.</p>");
                return;
            }
            
            filteredData.sort((a, b) => String(a.propertyNumber).localeCompare(String(b.propertyNumber), undefined, { numeric: true, sensitivity: 'base' }));

            // --- Grouping Data ---
            const PROPERTY_SECTIONS_MAP = {'Warehouse': 'warehouse', 'OPY': 'opy', 'Admin': 'admin', 'Others': 'others'};
            const sectionsToReport = ['Warehouse', 'OPY', 'Admin']; // Only report on these three major sections
            
            const groupedData = filteredData.reduce((acc, item) => {
                let itemType = item.propertyType ? item.propertyType.toLowerCase().replace(/\s/g, '') : 'others';
                // Robust routing logic (same as renderAllTables)
                if (itemType.includes('openyard')) itemType = 'opy';
                if (itemType.includes('adminbuilding')) itemType = 'admin';
                if (itemType === 'warehouse' || itemType === 'warehouses') itemType = 'warehouse';
                if (itemType === 'admin') itemType = 'admin';
                if (itemType === 'opy') itemType = 'opy';
                
                let sectionKey = 'Others';
                for(const key in PROPERTY_SECTIONS_MAP) {
                    if(PROPERTY_SECTIONS_MAP[key] === itemType) {
                        sectionKey = key;
                        break;
                    }
                }

                if (!acc[sectionKey]) acc[sectionKey] = [];
                acc[sectionKey].push(item);
                return acc;
            }, {});

            // --- Report Header ---
            const reportTitle = `Aman Certificate Financial History Report - ${currentProject}`;
            const reportDate = new Date().toLocaleDateString('en-GB');
            
            doc.setFontSize(18);
            doc.text(reportTitle, 14, 22);
            doc.setFontSize(11);
            doc.text(`Report generated on: ${reportDate}`, 14, 30);
            
            let totalInstallCostSummary = 0;
            let totalRenewalCostSummary = 0;
            let finalY = 35;


            // --- Helper to Generate Section Table ---
            const generateSectionTable = (sectionTitle, sectionData, startY) => {
                if (sectionData.length === 0) return startY;
                
                let groupInstallCost = 0;
                let groupRenewalCost = 0;
                
                // --- Table Headers (Fixed for Vertical Data) ---
                const head = [
                    [{ content: sectionTitle, colSpan: 5, styles: { fillColor: [176, 224, 230], textColor: [0, 0, 0], fontStyle: 'bold', halign: 'center' }}], // Light Blue Header
                    ['Prop No.', 'Expiry Date', 'Account ID', 'Install Info (Date / Cost)', 'Renewal History (Date / Cost)']
                ];
                
                // 3. Prepare table body
                const body = sectionData.map(item => {
                    const history = item.renewalHistory || [];
                    const installRecord = history.find(r => r.type === 'Installation') || {};
                    const renewalRecords = history.filter(r => r.type === 'Renewal').sort((a,b) => new Date(a.date) - new Date(b.date));	
                    
                    const installCost = parseFloat(installRecord.cost) || 0;
                    groupInstallCost += installCost;
                    totalInstallCostSummary += installCost;
                    
                    // Install Info Cell: Stack Date and Cost vertically
                    const installInfo = [
                        'Date: ' + (installRecord.date ? formatDate(installRecord.date) : 'N/A'),
                        'Cost: ' + ((installRecord.cost !== undefined && installRecord.cost !== '') ? `${parseFloat(installRecord.cost).toFixed(2)} AED` : 'N/A')
                    ].join('\n');

                    // Renewal History Cell: Stack ALL renewal pairs vertically
                    const renewalHistoryLines = renewalRecords.map((r, index) =>	
                        `R${index + 1}: ${formatDate(r.date)} / ${parseFloat(r.cost).toFixed(2)} AED`
                    );
                    const renewalInfo = renewalHistoryLines.length > 0 ? renewalHistoryLines.join('\n') : 'N/A';
                    
                    // Sum renewal costs for this specific row
                    let rowRenewalCost = 0;
                    renewalRecords.forEach(r => { rowRenewalCost += parseFloat(r.cost) || 0; });
                    groupRenewalCost += rowRenewalCost;
                    totalRenewalCostSummary += rowRenewalCost;

                    return [
                        item.propertyNumber || '',
                        formatDate(item.expiryDate),
                        item.accountId || 'N/A',
                        installInfo,
                        renewalInfo
                    ];
                });
                
                // --- Group Summary Row ---
                const summaryRow = [
                    { content: `Total ${sectionTitle} Costs:`, colSpan: 3, styles: { halign: 'right', fontStyle: 'bold', fillColor: [192, 222, 237], textColor: [0, 0, 0] } }, // Very Light Blue/Gray
                    { content: `Install: ${groupInstallCost.toFixed(2)} AED`, colSpan: 1, styles: { halign: 'center', fontStyle: 'bold', fillColor: [144, 238, 144], textColor: [0, 0, 0] } }, // Light Green
                    { content: `Renewal: ${groupRenewalCost.toFixed(2)} AED`, colSpan: 1, styles: { halign: 'center', fontStyle: 'bold', fillColor: [144, 238, 144], textColor: [0, 0, 0] } } // Light Green
                ];
                body.push(summaryRow);

                doc.autoTable({
                    startY: startY,
                    head: head,
                    body: body,
                    theme: 'striped',
                    styles: { fontSize: 8, cellPadding: 1.5, lineColor: [150, 150, 150], lineWidth: 0.1, valign: 'top', textColor: [0, 0, 0] }, // Black text
                    headStyles: { fillColor: [22, 160, 133], textColor: 255, fontStyle: 'bold' }, // Teal Header
                    alternateRowStyles: { fillColor: [230, 230, 230] }, // Very light rows
                    bodyStyles: { fillColor: [255, 255, 255] }, // White rows
                    margin: { top: 10, bottom: 10, left: 10, right: 10 } // Reduced margin for max width
                });

                return doc.lastAutoTable.finalY + 10; // Return new starting Y position
            };

            // 4. Generate Tables for Sections (Warehouse, OPY, Admin)
            sectionsToReport.forEach(section => {
                finalY = generateSectionTable(section, groupedData[section] || [], finalY);
            });

            // 4b. Generate table for 'Others' (if any)
            if (groupedData['Others'] && groupedData['Others'].length > 0) {
                 finalY = generateSectionTable('Others / Uncategorized', groupedData['Others'], finalY);
            }

            // 5. Overall Summary Section
            doc.setFontSize(14);
            doc.text('Overall Financial Summary (Filtered Records)', 14, finalY);
            
            doc.autoTable({
                startY: finalY + 5,
                head: [['Total Installation Cost (AED)', 'Total Renewal Cost (AED)', 'Total Lifetime Cost (AED)']],
                body: [
                    [
                        totalInstallCostSummary.toFixed(2),
                        totalRenewalCostSummary.toFixed(2),
                        (totalInstallCostSummary + totalRenewalCostSummary).toFixed(2)
                    ]
                ],
                theme: 'grid',
                styles: { cellPadding: 3, textColor: [0, 0, 0], fontStyle: 'bold' },
                headStyles: { fillColor: [44, 62, 80], textColor: 255 },	
                alternateRowStyles: { fillColor: [230, 230, 230] },
                bodyStyles: { fillColor: [255, 255, 255] },
                margin: { left: 14, right: 14 }
            });

            // --- Save ---
            doc.save(`Aman_Financial_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function handleDownloadReport(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape'); // Changed to landscape for wider Aman table
            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            const filters = currentFilters[type];
            
            // Helper function to safely get lowercase value of a field, defaulting to empty string if the property is null/undefined
            const getLower = (item, field) => String(item[field] || '').toLowerCase();

            // Filter for REPORT (Apply Project Filter)
            const projectData = dataArray.filter(c => (c.project || 'Main Project') === currentProject);

            const reportData = projectData.filter(item => {
                const validityMatch = filters.validity === 'All' || getValidityStatus(item.expiryDate).text === filters.validity;
                
                let searchMatch = !filters.search;
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    if (type === 'Aman Certificate') {
                        searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm)) ||
                                                (getLower(item, 'accountId').includes(searchTerm)) ||
                                                (getLower(item, 'recordId').includes(searchTerm)) ||
                                                (getLower(item, 'deviceId').includes(searchTerm)) ||	
                                                (getLower(item, 'serialNumber').includes(searchTerm));	
                    } else { // Civil Defence
                        searchMatch = (getLower(item, 'propertyNumber').includes(searchTerm));
                    }
                }
                const phaseMatch = filters.phase === 'All' || item.phase === filters.phase;
                const workflowMatch = filters.workflow === 'All' || item.workflowStatus === filters.workflow;
                return validityMatch && searchMatch && phaseMatch && workflowMatch;
            });

            if (reportData.length === 0) {
                showModal("Report Generation Failed", "<p class='text-yellow-400'>No data to report based on the current filters.</p>");
                return;
            }
            
            reportData.sort((a, b) => String(a.propertyNumber).localeCompare(String(b.propertyNumber), undefined, { numeric: true, sensitivity: 'base' }));

            const title = `${type} Certificate Report - ${currentProject}`;
            const date = new Date().toLocaleDateString('en-GB');
            
            doc.setFontSize(18);
            doc.text(title, 14, 22);
            doc.setFontSize(11);
            doc.text(`Report generated on: ${date}`, 14, 30);

            const isCivilDefence = type === 'Civil Defence';
            
            // Determine table headers based on type and conditional columns
            let headers = ['Property No.', 'Expiry Date', 'Validity', 'Workflow'];
            if(isCivilDefence) headers.splice(2, 0, 'Issue Date'); // Insert Issue Date for CD
            
            // Phase is NOT included in the PDF report for simplicity since it's now internal data for Warehouse records only
            
            if(type === 'Aman Certificate') {
                headers = ['Property No.', 'Phase', 'Expiry Date', 'Validity', 'Account ID', 'Record ID', 'Device ID', 'Serial No.'];
            }
            
            const head = [headers];

            const body = reportData.map(item => {
                if (isCivilDefence) {
                    let workflowText = item.workflowStatus || 'N/A';
                    if(item.workflowStatus === 'Inspection Date' && item.inspectionDate) {
                        workflowText = `Inspection: ${formatDate(item.inspectionDate)}`;
                    }
                    return [
                        item.propertyNumber || '',
                        // item.phase || '', // Phase removed from generic PDF report
                        formatDate(item.issueDate),
                        formatDate(item.expiryDate),
                        getValidityStatus(item.expiryDate).text,
                        workflowText
                    ];
                } else {
                    return [
                        item.propertyNumber || '',
                        item.phase || '', // Keeping phase for Aman report as it helps identify the physical location details
                        formatDate(item.expiryDate),
                        getValidityStatus(item.expiryDate).text,
                        item.accountId || '',
                        item.recordId || '',
                        item.deviceId || '',	
                        item.serialNumber || ''	
                    ];
                }
            });

            doc.autoTable({
                startY: 35,
                head: head,
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [22, 160, 133] }, // Teal color
            });

            doc.save(`${type.replace(/\s/g, '_')}_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function handleExportData(type, data) {
            // Filter Export Data by Current Project
            const projectData = data.filter(c => (c.project || 'Main Project') === currentProject);
            
            if (projectData.length === 0) {
                showModal("Export Failed", `<p class='text-yellow-400'>No data to export for ${type} in ${currentProject}.</p>`);
                return;
            }

            const jsonContent = JSON.stringify(projectData, null, 2);	
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${type.replace(/\s/g, '_')}_${currentProject.replace(/\s/g, '_')}_Export.json`;
            link.click();
            URL.revokeObjectURL(link.href);
        }
        
        function handleSetInspectionDate(id) {
            const modalContent = `
                <div class="space-y-4">
                    <label for="modalInspectionDate" class="block text-sm font-medium text-gray-300">Please select the inspection date:</label>
                    <input type="date" id="modalInspectionDate" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    <div class="flex justify-end mt-4">
                        <button id="save-inspection-date-btn" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Set Date</button>
                    </div>
                </div>`;

            showModal('Set Inspection Date', modalContent, () => {
                document.getElementById('save-inspection-date-btn').addEventListener('click', () => {
                    const newDate = document.getElementById('modalInspectionDate').value;
                    if (!newDate) {
                        showModal("Validation Error", "<p class='text-red-400'>Please select a date.</p>");
                        return;
                    }
                    const certIndex = cdCerts.findIndex(c => c.id === id);
                    if (certIndex !== -1) {
                        cdCerts[certIndex].workflowStatus = 'Inspection Date';
                        cdCerts[certIndex].inspectionDate = newDate;
                        saveDataToFirebase(); // Cloud Save
                        hideModal();
                        render();
                    }
                });
            });
        }
        
        function handleShowImportModal(type) {
            const modalContent = `
                <p class="text-gray-300 mb-4">Paste your JSON data below. Data must be an array of certificate objects for the current project:</p>
                <textarea id="import-json-data" rows="10" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-teal-500 font-mono text-sm" placeholder='[{"propertyNumber": "W123", "phase": "Phase 1", ...}, {"propertyNumber": "W124", "phase": "Phase 1", ...}]'></textarea>
                <div class="flex justify-end gap-4 pt-4">
                    <button id="import-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold">Cancel</button>
                    <button id="import-confirm-btn" class="px-6 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-500 transition-colors font-semibold">Import Data</button>
                </div>
            `;
            
            showModal(`Import ${type} Data for ${currentProject}`, modalContent, () => {
                document.getElementById('import-cancel-btn').addEventListener('click', hideModal);
                document.getElementById('import-confirm-btn').addEventListener('click', () => {
                    const jsonString = document.getElementById('import-json-data').value;
                    try {
                        const importedData = JSON.parse(jsonString);
                        if (!Array.isArray(importedData)) {
                            throw new Error("Data must be a JSON array.");
                        }

                        let successfulImports = 0;
                        let failedImports = 0;
                        
                        importedData.forEach(newCertData => {
                            if (!newCertData.propertyNumber) {
                                failedImports++;
                                return;
                            }
                            
                            // 1. Ensure it doesn't duplicate an existing ID OR propertyNumber in this project
                            const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
                            const isDuplicate = dataArray.some(cert => 
                                (cert.id === newCertData.id) || 
                                (cert.propertyNumber.trim().toLowerCase() === newCertData.propertyNumber.trim().toLowerCase() && (cert.project || 'Main Project') === currentProject)
                            );

                            if (isDuplicate) {
                                failedImports++;
                                return;
                            }
                            
                            // 2. Assign default and current project values if missing/not provided
                            newCertData.project = currentProject;
                            newCertData.id = newCertData.id || String(Date.now()) + '-' + crypto.randomUUID().substring(0, 4);
                            newCertData.createdAt = newCertData.createdAt || new Date().toISOString();

                            // 3. Merge or push into master array
                            if (type === 'Civil Defence') {
                                cdCerts.push(newCertData);
                            } else {
                                amanCerts.push({
                                    ...newCertData, 
                                    renewalHistory: newCertData.renewalHistory || []
                                });
                            }
                            successfulImports++;
                        });
                        
                        saveDataToFirebase();
                        hideModal();
                        render();
                        showModal("Import Complete", `<p class='text-green-400'>Successfully imported ${successfulImports} new records. ${failedImports > 0 ? `<span class="text-yellow-400">(${failedImports} skipped due to missing Property Number or duplication.)</span>` : ''}</p>`);

                    } catch (error) {
                        showModal("Import Error", `<p class='text-red-400'>Invalid JSON format or data structure. Please ensure it's a valid JSON array of objects. Error: ${error.message}</p>`);
                    }
                });
            });
        }


        // --- Global Form Save Handler (Moved outside handleShowForm to fix scope error) ---
        function handleSave(e, type, id) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            let data = Object.fromEntries(formData.entries());
            
            handleOperation(type, id ? 'update' : 'add', id, data);
        }

        // --- Global CRUD Operation Handler (Moved inside module scope) ---
        function handleOperation(type, operation, id, data) {
            if (operation === 'delete') {
                // Replaced confirm() with modal
                showModal("Confirm Deletion", "<p class='text-gray-300'>Are you sure you want to permanently delete this certificate record?</p><div class='flex justify-end gap-4 mt-6'><button id='confirm-delete' class='px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 transition-colors font-semibold'>Delete</button><button id='cancel-delete' class='px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors font-semibold'>Cancel</button></div>", () => {
                    document.getElementById('confirm-delete').addEventListener('click', () => {
                        if(type === 'Civil Defence') {
                            cdCerts = cdCerts.filter(c => c.id !== id);
                        } else {
                            amanCerts = amanCerts.filter(c => c.id !== id);
                        }
                        saveDataToFirebase(); // Cloud Save
                        render();
                        hideModal();
                    });
                    document.getElementById('cancel-delete').addEventListener('click', hideModal);
                });
                return;	
            }

            let dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
            
            // Determine Project
            const entryProject = (data && data.project) ? data.project : currentProject;
            
            const propertyNumber = data.propertyNumber.trim();

            if (!propertyNumber) {
                showModal("Validation Error", "<p class='text-red-400'>Property Number cannot be empty.</p>");
                return;
            }

            if (operation === 'add') {
                // Check duplicate WITHIN current project - THIS IS THE CASE-INSENSITIVE VALIDATION
                const isDuplicate = dataArray.some(cert => cert.propertyNumber.trim().toLowerCase() === propertyNumber.toLowerCase() && (cert.project || 'Main Project') === entryProject);
                if (isDuplicate) {
                    showModal("Validation Error", `<p class='text-red-400'>Error: A certificate for Property Number "${propertyNumber}" already exists in this project. (It may be stored with different capitalization, please search for it to find it.)</p>`);
                    return;
                }

                // Conditionally build Aman-specific data object
                const amanFields = type === 'Aman Certificate' ? {
                    deviceId: data.deviceId || '',
                    serialNumber: data.serialNumber || '',
                    // NEW: Initialize renewalHistory on creation
                    renewalHistory: data.renewalHistory || []	
                } : {};

                let newCert = {	
                    ...data,	
                    propertyNumber,	
                    id: String(Date.now()) + '-' + crypto.randomUUID().substring(0, 4),	
                    createdAt: new Date().toISOString(),
                    project: entryProject,
                    // Spread Aman fields only if type is Aman
                    ...amanFields,
                    // Link Field
                    certificateLink: data.certificateLink || ''
                };

                // BUG FIX: Check if workflowStatus was passed (from import), otherwise use default logic
                if(type === 'Civil Defence'){
                    if (data.workflowStatus) {
                        newCert.workflowStatus = data.workflowStatus;
                    } else {
                        newCert.workflowStatus = data.amcOnly === 'on' ? 'AMC ready' : 'Renewal Pending';
                    }
                    
                    if(data.amcOnly === 'on'){
                        newCert.issueDate = '';
                        newCert.expiryDate = '';
                    }
                } else if (type === 'Aman Certificate') {
                    if (data.workflowStatus) {
                        newCert.workflowStatus = data.workflowStatus;
                    } else {
                        newCert.workflowStatus = 'Installation in Progress';
                    }
                }
                dataArray.push(newCert);
            } else if (operation === 'update') {
                const isDuplicate = dataArray.some(cert => cert.propertyNumber.trim().toLowerCase() === propertyNumber.toLowerCase() && cert.id !== id && (cert.project || 'Main Project') === entryProject);
                 if (isDuplicate) {
                    showModal("Validation Error", `<p class='text-red-400'>Error: Another certificate with Property Number "${propertyNumber}" already exists in this project.</p>`);
                    return;	
                }
                const certIndex = dataArray.findIndex(c => c.id === id);
                if (certIndex !== -1) {
                    const originalCert = { ...dataArray[certIndex] };
                    
                    // HISTORY LOGIC ADDED HERE (For Old Expiry/Link)
                    if (!historyData[id]) {
                        historyData[id] = [];
                    }
                    // Only push old version if expiry or link changed
                    if (originalCert.expiryDate !== data.expiryDate || originalCert.certificateLink !== data.certificateLink) {
                       historyData[id].push({	
                            ...originalCert,	
                            archivedAt: new Date().toISOString(),
                            // Keep only relevant historical fields to save space
                            // FIX: Ensure no undefined values for Firebase set()
                            expiryDate: originalCert.expiryDate || '',
                            certificateLink: originalCert.certificateLink || ''
                        });
                    }
                    
                    // FIX 4: Since phase and propertyType are now editable, we don't force them back from originalCert.
                    let updatedCert = { ...originalCert, ...data, propertyNumber, lastUpdated: new Date().toISOString() };
                    
                    if (data.isRenewal === 'true') {
                        updatedCert.workflowStatus = 'Certificate ready';	
                        updatedCert.inspectionDate = '';	
                        updatedCert.amcOnly = false; // A renewal implies it's not AMC only
                    }
                    
                    if(type === 'Civil Defence' && data.amcOnly === 'on'){
                        updatedCert.workflowStatus = 'AMC ready';
                        updatedCert.issueDate = '';
                        updatedCert.expiryDate = '';
                    }

                    // Aman Fields handling on update
                    if (type === 'Aman Certificate') {
                        updatedCert.accountId = data.accountId || '';
                        updatedCert.recordId = data.recordId || '';
                        updatedCert.deviceId = data.deviceId || '';
                        updatedCert.serialNumber = data.serialNumber || '';
                        // Preserve the renewalHistory array
                        updatedCert.renewalHistory = originalCert.renewalHistory || [];
                    } else {
                        // Ensure CD certs DO NOT have these properties when saving to Firebase
                        delete updatedCert.deviceId;
                        delete updatedCert.serialNumber;
                        delete updatedCert.renewalHistory;
                    }
                    
                    // Update certificate link
                    updatedCert.certificateLink = data.certificateLink || '';
                    
                    dataArray[certIndex] = updatedCert;
                }
            }
            
            saveDataToFirebase(); // Cloud Save
            hideModal();
            render();
            updateNotifications(); // Update notifications after saving data
        }


        // --- Event Listeners ---
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.workflow-status-btn') && !e.target.closest('#notification-btn')) {
                // Close workflow dropdowns
                document.querySelectorAll('[id^="workflow-dropdown-"]').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                });
                // Close notification dropdown
                if (!e.target.closest('#notification-dropdown')) {
                    document.getElementById('notification-dropdown').classList.add('hidden');
                }
            }
        });

        document.getElementById('navigation').addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                currentPage = navLink.dataset.page;
                render();
            }
        });

        // ADDED: Notification button toggle
        document.getElementById('notification-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
        });
        
        document.querySelector('main').addEventListener('click', (e) => {
            const actionBtn = e.target.closest('.action-btn');
            const workflowBtn = e.target.closest('.workflow-status-btn');
            const workflowOption = e.target.closest('.workflow-option');

            if (workflowBtn) {
                e.preventDefault();
                e.stopPropagation();	
                const id = workflowBtn.dataset.id;
                const dropdown = document.getElementById(`workflow-dropdown-${id}`);
                
                document.querySelectorAll('[id^="workflow-dropdown-"]').forEach(d => {
                    if (d.id !== dropdown.id) {
                        d.classList.add('hidden');
                    }
                });

                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            } else if (workflowOption) {
                e.preventDefault();
                const id = workflowOption.dataset.id;
                const newStatus = workflowOption.dataset.newStatus;
                const type = workflowOption.dataset.type;
                
                const dataArray = type === 'Civil Defence' ? cdCerts : amanCerts;
                const certIndex = dataArray.findIndex(c => c.id === id);
                if (certIndex === -1) return;

                if (newStatus === 'Inspection Date' && type === 'Civil Defence') {	
                    handleSetInspectionDate(id);
                } else {
                    dataArray[certIndex].workflowStatus = newStatus;
                    if (newStatus !== 'Inspection Date') {
                        dataArray[certIndex].inspectionDate = '';
                    }
                    saveDataToFirebase(); // Cloud Save
                    render();
                }
                
                workflowOption.closest('[id^="workflow-dropdown-"]').classList.add('hidden');
            } else if (actionBtn) {
                const { action, id, type } = actionBtn.dataset;
                if (action === 'edit') {
                    handleShowForm(type, id);
                } else if (action === 'delete') {
                    handleOperation(type, 'delete', id, null);	
                } else if (action === 'history') {
                    if (type === 'Aman Certificate') {
                        // The financial history view is accessed via the edit modal now,
                        // but keeping the direct button for backward compatibility or general history.
                        handleShowHistoryModal(id);	
                    } else {
                        handleShowHistoryModal(id); // Expiry/Link history for CD and Aman
                    }
                } else if (action === 'view-details') {	
                    handleShowDetailsModal(id, type);
                } else if (action === 'update-inspection') {
                    handleUpdateInspectionStatus(id);
                } else if (action === 'renew') { // NEW RENEWAL ACTION
                    handleShowRenewalModal(type, id);
                }
            }
        });

        // --- Initialization ---
        function initialize() {
            // We wait for auth to complete to load data from Firebase
        }

        initialize();
    </script>
</body>
</html>
